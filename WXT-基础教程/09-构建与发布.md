# 构建与发布

> **导航**: [上一章: React集成开发](./08-React集成开发.md) | [下一章: 自动导入系统](./10-自动导入系统.md) | [返回目录](../README.md)
>
> **配套实战**: [构建发布实战](../WXT-实战练习/09-构建发布实战.md)

---

## 前言

完成开发后，我们需要将插件构建为可发布的格式，并提交到各大浏览器商店。WXT 提供了强大的构建工具链，支持多浏览器、多 Manifest 版本的构建，让发布流程变得简单高效。

本章将详细介绍从构建到发布的完整流程，包括环境变量配置、版本管理、国际化支持、商店提交以及自动化发布等内容。

---

## 1. 构建流程

### 1.1 开发构建

开发阶段使用 `dev` 命令，WXT 会启动开发服务器并监听文件变化，实现热重载:

```bash
# 启动开发服务器 (默认 Chrome)
pnpm dev

# 指定浏览器
pnpm dev -b firefox
pnpm dev -b edge
pnpm dev -b safari
```

**开发模式特点**:
- 文件变化时自动重新构建
- 支持 HMR (热模块替换)
- 自动在浏览器中加载/重载插件
- 输出未压缩代码，便于调试

### 1.2 生产构建

生产环境使用 `build` 命令，WXT 会进行代码优化、压缩、Tree Shaking 等处理:

```bash
# 构建生产版本
pnpm build

# 指定浏览器和 Manifest 版本
pnpm build -b chrome
pnpm build -b firefox
pnpm build -b edge

# 同时构建多个目标
pnpm build -b chrome -b firefox
```

**生产构建特点**:
- 代码压缩和混淆
- Tree Shaking 移除未使用代码
- 资源优化 (图片压缩、CSS 合并等)
- 生成 Source Map (可选)

### 1.3 打包为 ZIP

商店提交需要 ZIP 格式的压缩包:

```bash
# 打包用于商店提交
pnpm zip

# 指定浏览器
pnpm zip -b chrome
pnpm zip -b firefox
```

输出文件位于:
- `.output/chrome-mv3.zip` - Chrome 插件包
- `.output/firefox-mv2.zip` - Firefox 插件包

---

## 2. 构建配置

### 2.1 wxt.config.ts 完整配置

`wxt.config.ts` 是 WXT 的核心配置文件，控制构建行为的方方面面:

```typescript
// wxt.config.ts
import { defineConfig } from 'wxt';

export default defineConfig({
  // ========== 目录配置 ==========
  // 源码目录 (相对于项目根目录)
  srcDir: 'src',
  
  // 入口点目录 (相对于 srcDir)
  entrypointsDir: 'entrypoints',
  
  // 输出目录
  outDir: '.output',
  
  // 静态资源目录
  publicDir: 'public',
  
  // 输出目录命名模板
  // 可用变量: browser, manifestVersion, mode, name, version
  outDirTemplate: '{{browser}}-mv{{manifestVersion}}',
  
  // ========== 构建目标 ==========
  // 默认目标浏览器
  browser: 'chrome',
  
  // Manifest 版本 (2 或 3)
  manifestVersion: 3,
  
  // ========== Manifest 配置 ==========
  manifest: {
    name: 'My Extension',
    version: '1.0.0',
    description: 'A browser extension built with WXT',
    
    // 权限配置
    permissions: [
      'storage',      // 存储权限
      'activeTab',    // 当前标签页权限
      'contextMenus', // 右键菜单权限
    ],
    
    // 主机权限 (MV3)
    host_permissions: [
      '<all_urls>',
    ],
    
    // 图标配置
    icons: {
      16: '/icon/16.png',
      32: '/icon/32.png',
      48: '/icon/48.png',
      128: '/icon/128.png',
    },
  },
  
  // ========== Vite 配置 ==========
  vite: () => ({
    plugins: [],
    build: {
      // 生成 Source Map 便于调试
      sourcemap: true,
    },
  }),
  
  // ========== 开发服务器配置 ==========
  dev: {
    server: {
      port: 3000,
    },
  },
  
  // ========== 构建分析 ==========
  analysis: {
    enabled: true,  // 启用构建分析
    open: true,     // 自动打开分析报告
  },
  
  // ========== ZIP 打包配置 ==========
  zip: {
    // 插件包命名模板
    artifactTemplate: '{{name}}-{{version}}-{{browser}}.zip',
    // 源码包命名模板 (Firefox 可能需要)
    sourcesTemplate: '{{name}}-{{version}}-sources.zip',
  },
});
```

### 2.2 动态 Manifest

有时需要根据目标浏览器或构建模式动态调整 Manifest。WXT 支持函数形式的 manifest 配置:

```typescript
export default defineConfig({
  manifest: ({ browser, manifestVersion, mode }) => {
    // 基础配置
    const baseManifest = {
      name: 'My Extension',
      version: '1.0.0',
    };
    
    // 根据浏览器调整 (Firefox 需要特殊配置)
    if (browser === 'firefox') {
      return {
        ...baseManifest,
        // Firefox 必须配置 gecko id
        browser_specific_settings: {
          gecko: {
            id: 'my-extension@example.com',
            strict_min_version: '109.0',
          },
        },
      };
    }
    
    // 根据 Manifest 版本调整 (MV2 vs MV3 API 差异)
    if (manifestVersion === 2) {
      return {
        ...baseManifest,
        // MV2 使用 browser_action
        browser_action: {
          default_popup: 'popup.html',
        },
      };
    }
    
    // MV3 使用 action
    return {
      ...baseManifest,
      action: {
        default_popup: 'popup.html',
      },
    };
  },
});
```

**动态配置的应用场景**:
- 不同浏览器需要不同的权限
- MV2 和 MV3 的 API 差异处理
- 开发模式和生产模式的不同配置
- 根据环境变量调整配置

---

## 3. 环境变量

### 3.1 配置环境变量

WXT 基于 Vite，支持标准的 `.env` 文件:

```bash
# .env - 所有环境通用
VITE_API_URL=https://api.example.com
VITE_APP_NAME=My Extension

# .env.development - 仅开发环境
VITE_API_URL=http://localhost:3001
VITE_DEBUG=true

# .env.production - 仅生产环境
VITE_API_URL=https://api.example.com
VITE_DEBUG=false
```

**注意**: 只有以 `VITE_` 开头的变量才会被暴露给客户端代码。

### 3.2 使用环境变量

在代码中通过 `import.meta.env` 访问环境变量:

```typescript
// 自定义环境变量
const apiUrl = import.meta.env.VITE_API_URL;
const isDebug = import.meta.env.VITE_DEBUG === 'true';

// 内置环境变量
const isDev = import.meta.env.DEV;      // 是否开发模式
const isProd = import.meta.env.PROD;    // 是否生产模式
const mode = import.meta.env.MODE;      // 当前模式: 'development' | 'production'
```

### 3.3 类型声明

为环境变量添加 TypeScript 类型支持:

```typescript
// env.d.ts
interface ImportMetaEnv {
  readonly VITE_API_URL: string;
  readonly VITE_APP_NAME: string;
  readonly VITE_DEBUG: string;
}

interface ImportMeta {
  readonly env: ImportMetaEnv;
}
```

---

## 4. 版本管理

### 4.1 自动版本号

推荐从 `package.json` 读取版本号，保持一致性:

```typescript
// wxt.config.ts
import pkg from './package.json';

export default defineConfig({
  manifest: {
    version: pkg.version,
  },
});
```

### 4.2 版本号规范

Chrome Web Store 对版本号有严格要求:

| 规则 | 说明 |
|------|------|
| 格式 | `major.minor.patch.build` (最多 4 段) |
| 每段最大值 | 65535 |
| 示例 | `1.0.0`, `1.2.3`, `2.0.0.1` |
| 递增规则 | 每次提交必须大于上一版本 |

```json
// package.json
{
  "version": "1.0.0"
}
```

---

## 5. 国际化 (i18n)

> **详细教程**: 参见 [国际化i18n](./11-国际化i18n.md)

### 5.1 配置多语言

在 `public/_locales` 目录下创建语言文件:

```
public/
└── _locales/
    ├── en/
    │   └── messages.json
    ├── zh_CN/
    │   └── messages.json
    └── ja/
        └── messages.json
```

### 5.2 消息文件格式

```json
// public/_locales/en/messages.json
{
  "extensionName": {
    "message": "My Extension",
    "description": "Name of the extension"
  },
  "extensionDescription": {
    "message": "A powerful browser extension",
    "description": "Description of the extension"
  },
  "buttonTranslate": {
    "message": "Translate",
    "description": "Translate button text"
  }
}
```

```json
// public/_locales/zh_CN/messages.json
{
  "extensionName": {
    "message": "我的插件"
  },
  "extensionDescription": {
    "message": "一个强大的浏览器插件"
  },
  "buttonTranslate": {
    "message": "翻译"
  }
}
```

### 5.3 在 Manifest 中使用

使用 `__MSG_key__` 语法引用多语言消息:

```typescript
// wxt.config.ts
export default defineConfig({
  manifest: {
    name: '__MSG_extensionName__',
    description: '__MSG_extensionDescription__',
    default_locale: 'en', // 必须指定默认语言
  },
});
```

### 5.4 在代码中使用

```typescript
// 获取本地化消息
const name = browser.i18n.getMessage('extensionName');
const translate = browser.i18n.getMessage('buttonTranslate');

// 带占位符的消息
// messages.json: "greeting": { "message": "Hello, $NAME$!", "placeholders": { "name": { "content": "$1" } } }
const greeting = browser.i18n.getMessage('greeting', ['John']);
```

### 5.5 React 中使用

创建 Hook 封装 i18n 功能:

```typescript
// hooks/useI18n.ts
import { useMemo } from 'react';

export function useI18n() {
  return useMemo(() => ({
    t: (key: string, substitutions?: string | string[]) => 
      browser.i18n.getMessage(key, substitutions) || key,
    locale: browser.i18n.getUILanguage(),
  }), []);
}

// 使用
function Component() {
  const { t } = useI18n();
  
  return <button>{t('buttonTranslate')}</button>;
}
```

---

## 6. 发布到 Chrome Web Store

### 6.1 准备材料

发布前需要准备以下材料:

**图标要求**:
| 类型 | 尺寸 | 用途 |
|------|------|------|
| 商店图标 | 128x128 PNG | 商店列表显示 |
| 小型宣传图 | 440x280 PNG | 商店展示 |
| 大型宣传图 | 1280x800 PNG | 可选，精选展示 |
| 截图 | 1280x800 或 640x400 | 至少 1 张 |

**文案要求**:
- 名称: 最多 45 字符
- 简短描述: 最多 132 字符
- 详细描述: 无限制，支持 Markdown

**隐私政策**: 如使用敏感权限 (如 `<all_urls>`)，必须提供隐私政策链接

### 6.2 打包上传

```bash
# 生产构建并打包
pnpm build
pnpm zip
```

上传 `.output/chrome-mv3.zip` 到 [Chrome Web Store Developer Dashboard](https://chrome.google.com/webstore/devconsole)。

### 6.3 审核注意事项

| 常见拒绝原因 | 解决方案 |
|--------------|----------|
| 权限过多 | 只申请必要权限，在描述中说明用途 |
| 缺少隐私政策 | 提供清晰的隐私政策页面 |
| 功能不明确 | 提供详细的功能描述和截图 |
| 代码混淆 | 提交源码包供审核 |

---

## 7. 发布到 Firefox Add-ons

### 7.1 Firefox 特殊配置

Firefox 需要在 Manifest 中配置 gecko 信息:

```typescript
// wxt.config.ts
export default defineConfig({
  manifest: {
    browser_specific_settings: {
      gecko: {
        id: 'my-extension@example.com', // 唯一 ID
        strict_min_version: '109.0',     // 最低 Firefox 版本
      },
    },
  },
});
```

### 7.2 打包

```bash
pnpm build -b firefox
pnpm zip -b firefox
```

上传 `.output/firefox-mv2.zip` 到 [Firefox Add-ons Developer Hub](https://addons.mozilla.org/developers/)。

### 7.3 源码提交

Firefox 审核可能要求提交源码:

```bash
# 打包源码
pnpm zip:sources
```

---

## 8. 自动化发布

### 8.1 GitHub Actions

使用 GitHub Actions 实现自动构建和发布:

```yaml
# .github/workflows/release.yml
name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: pnpm/action-setup@v2
        with:
          version: 8
          
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          
      - run: pnpm install
      - run: pnpm build
      - run: pnpm zip
      
      # 上传构建产物
      - name: Upload Chrome Extension
        uses: actions/upload-artifact@v4
        with:
          name: chrome-extension
          path: .output/*.zip
          
      # 创建 GitHub Release
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: .output/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
```

### 8.2 自动发布到商店

使用 CLI 工具自动上传到商店:

```yaml
# 自动发布到 Chrome Web Store
- name: Upload to Chrome Web Store
  run: npx chrome-webstore-upload-cli upload --source .output/chrome-mv3.zip
  env:
    EXTENSION_ID: ${{ secrets.CHROME_EXTENSION_ID }}
    CLIENT_ID: ${{ secrets.CHROME_CLIENT_ID }}
    CLIENT_SECRET: ${{ secrets.CHROME_CLIENT_SECRET }}
    REFRESH_TOKEN: ${{ secrets.CHROME_REFRESH_TOKEN }}
```

---

## 9. 调试与测试

### 9.1 加载未打包扩展

**Chrome**:
1. 打开 `chrome://extensions`
2. 启用"开发者模式"
3. 点击"加载已解压的扩展程序"
4. 选择 `.output/chrome-mv3` 目录

**Firefox**:
1. 打开 `about:debugging`
2. 点击"此 Firefox"
3. 点击"临时载入附加组件"
4. 选择 `.output/firefox-mv2/manifest.json`

### 9.2 生产环境调试

```typescript
// 仅开发环境输出调试信息
if (import.meta.env.DEV) {
  console.log('Debug info:', data);
}

// 生产环境保留必要日志
console.info('[Extension] Initialized');
```

---

## 10. 小结

| 命令 | 说明 |
|------|------|
| `pnpm dev` | 开发模式，支持热重载 |
| `pnpm build` | 生产构建 |
| `pnpm zip` | 打包 ZIP |
| `pnpm dev -b firefox` | Firefox 开发 |
| `pnpm build -b chrome -b firefox` | 多浏览器构建 |

**发布检查清单**:
- [ ] 版本号已更新
- [ ] 所有功能测试通过
- [ ] 图标和截图准备完毕
- [ ] 隐私政策链接有效
- [ ] 权限说明清晰

---

> **下一步**: 了解 [自动导入系统](./10-自动导入系统.md)，简化代码导入
>
> **官方文档**: [WXT Building](https://wxt.dev/guide/essentials/building.html)
