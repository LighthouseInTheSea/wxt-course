# WXT 国际化 (i18n)

## 1. 国际化概述

WXT 提供了两种国际化方案:

1. **原生 Chrome i18n API**: 使用 `_locales` 目录和 `browser.i18n.getMessage()`
2. **@wxt-dev/i18n 模块**: 增强的 i18n 解决方案,支持 YAML、嵌套键等高级特性

## 2. 原生 i18n 方案

### 2.1 创建语言文件

在 `public/_locales` 目录下创建语言文件:

```
public/
└── _locales/
    ├── en/
    │   └── messages.json
    ├── zh_CN/
    │   └── messages.json
    └── ja/
        └── messages.json
```

### 2.2 messages.json 格式

```json
// public/_locales/en/messages.json
{
  "extName": {
    "message": "My Extension",
    "description": "Extension name"
  },
  "extDescription": {
    "message": "A powerful browser extension",
    "description": "Extension description"
  },
  "greeting": {
    "message": "Hello, $USER$!",
    "description": "Greeting message",
    "placeholders": {
      "user": {
        "content": "$1",
        "example": "John"
      }
    }
  },
  "itemCount": {
    "message": "You have $COUNT$ items",
    "placeholders": {
      "count": {
        "content": "$1"
      }
    }
  }
}
```

```json
// public/_locales/zh_CN/messages.json
{
  "extName": {
    "message": "我的扩展"
  },
  "extDescription": {
    "message": "一个强大的浏览器扩展"
  },
  "greeting": {
    "message": "你好, $USER$!",
    "placeholders": {
      "user": {
        "content": "$1"
      }
    }
  },
  "itemCount": {
    "message": "你有 $COUNT$ 个项目",
    "placeholders": {
      "count": {
        "content": "$1"
      }
    }
  }
}
```

### 2.3 配置默认语言

```typescript
// wxt.config.ts
export default defineConfig({
  manifest: {
    name: '__MSG_extName__',
    description: '__MSG_extDescription__',
    default_locale: 'en',
  },
});
```

### 2.4 在代码中使用

```typescript
// 获取翻译
const greeting = browser.i18n.getMessage('greeting', ['John']);
console.log(greeting); // "Hello, John!" 或 "你好, John!"

// 获取当前语言
const uiLanguage = browser.i18n.getUILanguage();
console.log(uiLanguage); // "en" 或 "zh-CN"
```

## 3. @wxt-dev/i18n 模块 (推荐)

这个模块提供了更现代化的 i18n 体验,支持 YAML 格式、嵌套键、类型安全等特性。

### 3.1 安装配置

```bash
pnpm add @wxt-dev/i18n
```

```typescript
// wxt.config.ts
export default defineConfig({
  modules: ['@wxt-dev/i18n'],
  manifest: {
    name: '__MSG_extName__',
    description: '__MSG_extDescription__',
    default_locale: 'en',
  },
});
```

### 3.2 创建语言文件

使用 YAML 格式 (推荐):

```yaml
# src/locales/en.yml
extName: My Extension
extDescription: A powerful browser extension

common:
  ok: OK
  cancel: Cancel
  save: Save
  delete: Delete

welcome:
  title: Welcome
  subtitle: Thanks for installing!
  
settings:
  title: Settings
  language: Language
  theme: Theme
  themes:
    light: Light
    dark: Dark
    system: System
```

```yaml
# src/locales/zh_CN.yml
extName: 我的扩展
extDescription: 一个强大的浏览器扩展

common:
  ok: 确定
  cancel: 取消
  save: 保存
  delete: 删除

welcome:
  title: 欢迎
  subtitle: 感谢安装!
  
settings:
  title: 设置
  language: 语言
  theme: 主题
  themes:
    light: 浅色
    dark: 深色
    system: 跟随系统
```

也支持 JSON 格式:

```json
// src/locales/en.json
{
  "extName": "My Extension",
  "common": {
    "ok": "OK",
    "cancel": "Cancel"
  }
}
```

### 3.3 使用翻译

```typescript
import { i18n } from '#i18n';

// 简单翻译
const title = i18n.t('welcome.title');
console.log(title); // "Welcome" 或 "欢迎"

// 嵌套键
const theme = i18n.t('settings.themes.dark');
console.log(theme); // "Dark" 或 "深色"

// 带参数的翻译 (需要在 YAML 中使用占位符)
const greeting = i18n.t('greeting', { name: 'John' });
```

### 3.4 React 组件中使用

```tsx
// components/SettingsPanel.tsx
import { i18n } from '#i18n';

export function SettingsPanel() {
  return (
    <div className="settings">
      <h1>{i18n.t('settings.title')}</h1>
      
      <label>
        {i18n.t('settings.language')}
        <select>
          <option value="en">English</option>
          <option value="zh_CN">中文</option>
        </select>
      </label>
      
      <label>
        {i18n.t('settings.theme')}
        <select>
          <option value="light">{i18n.t('settings.themes.light')}</option>
          <option value="dark">{i18n.t('settings.themes.dark')}</option>
          <option value="system">{i18n.t('settings.themes.system')}</option>
        </select>
      </label>
      
      <div className="actions">
        <button>{i18n.t('common.cancel')}</button>
        <button>{i18n.t('common.save')}</button>
      </div>
    </div>
  );
}
```

## 4. 带参数的翻译

### 4.1 定义带参数的消息

```yaml
# src/locales/en.yml
messages:
  welcome: "Welcome, {name}!"
  itemCount: "You have {count} items"
  dateFormat: "Last updated: {date}"
```

```yaml
# src/locales/zh_CN.yml
messages:
  welcome: "欢迎, {name}!"
  itemCount: "你有 {count} 个项目"
  dateFormat: "最后更新: {date}"
```

### 4.2 使用参数

```typescript
import { i18n } from '#i18n';

const welcome = i18n.t('messages.welcome', { name: 'Alice' });
// "Welcome, Alice!" 或 "欢迎, Alice!"

const items = i18n.t('messages.itemCount', { count: 5 });
// "You have 5 items" 或 "你有 5 个项目"
```

## 5. VS Code 集成

### 5.1 安装 i18n Ally 插件

推荐安装 [i18n Ally](https://marketplace.visualstudio.com/items?itemName=lokalise.i18n-ally) 插件,提供:

- 内联翻译预览
- 快速跳转到翻译定义
- 自动补全翻译键

### 5.2 配置 i18n Ally

```json
// .vscode/settings.json
{
  "i18n-ally.localesPaths": ["src/locales"],
  "i18n-ally.keystyle": "nested",
  "i18n-ally.sourceLanguage": "en",
  "i18n-ally.displayLanguage": "zh_CN"
}
```

创建自定义框架配置:

```yaml
# .vscode/i18n-ally-custom-framework.yml
languageIds:
  - typescript
  - typescriptreact

usageMatchRegex:
  - "[^\\w\\d]i18n\\.t\\(['\"`]({key})['\"`]"

monopoly: true
```

## 6. 类型安全

### 6.1 生成类型定义

@wxt-dev/i18n 会自动生成类型定义,提供完整的类型安全:

```typescript
import { i18n } from '#i18n';

// TypeScript 会自动提示所有可用的翻译键
i18n.t('settings.title');      // OK
i18n.t('settings.themes.dark'); // OK
i18n.t('nonexistent.key');      // 类型错误!
```

## 7. 动态语言切换

### 7.1 获取当前语言

```typescript
// 获取浏览器 UI 语言
const uiLang = browser.i18n.getUILanguage();

// 获取扩展支持的语言列表
const supportedLangs = ['en', 'zh_CN', 'ja'];
```

### 7.2 存储用户语言偏好

```typescript
import { storage } from 'wxt/storage';

// 定义语言偏好存储
const languageStorage = storage.defineItem<string>('local:language', {
  fallback: 'en',
});

// 获取用户语言
const userLang = await languageStorage.getValue();

// 设置用户语言
await languageStorage.setValue('zh_CN');
```

## 8. 完整示例

### 8.1 项目结构

```
src/
├── locales/
│   ├── en.yml
│   ├── zh_CN.yml
│   └── ja.yml
├── entrypoints/
│   ├── popup/
│   │   ├── index.html
│   │   ├── main.tsx
│   │   └── App.tsx
│   └── background.ts
└── components/
    └── LanguageSelector.tsx
```

### 8.2 语言选择器组件

```tsx
// components/LanguageSelector.tsx
import { useState, useEffect } from 'react';
import { i18n } from '#i18n';
import { storage } from 'wxt/storage';

const languages = [
  { code: 'en', name: 'English' },
  { code: 'zh_CN', name: '中文' },
  { code: 'ja', name: '日本語' },
];

const langStorage = storage.defineItem<string>('sync:language', {
  fallback: browser.i18n.getUILanguage().replace('-', '_'),
});

export function LanguageSelector() {
  const [currentLang, setCurrentLang] = useState('en');
  
  useEffect(() => {
    langStorage.getValue().then(setCurrentLang);
  }, []);
  
  const handleChange = async (lang: string) => {
    await langStorage.setValue(lang);
    setCurrentLang(lang);
    // 注意: 更改语言后可能需要重新加载扩展
  };
  
  return (
    <select 
      value={currentLang} 
      onChange={(e) => handleChange(e.target.value)}
    >
      {languages.map((lang) => (
        <option key={lang.code} value={lang.code}>
          {lang.name}
        </option>
      ))}
    </select>
  );
}
```

## 9. 最佳实践

### 9.1 翻译键命名规范

```yaml
# 推荐: 使用语义化的嵌套结构
common:
  buttons:
    save: Save
    cancel: Cancel
pages:
  settings:
    title: Settings
errors:
  network: Network error
  timeout: Request timeout

# 避免: 扁平的、无意义的键名
btn1: Save
btn2: Cancel
title1: Settings
```

### 9.2 处理复数

```yaml
# en.yml
items:
  zero: No items
  one: 1 item
  other: "{count} items"

# 使用
const text = count === 0 
  ? i18n.t('items.zero')
  : count === 1 
    ? i18n.t('items.one')
    : i18n.t('items.other', { count });
```

### 9.3 RTL 语言支持

```css
/* 支持从右到左的语言 */
:root[dir="rtl"] {
  direction: rtl;
}

.sidebar {
  /* 使用逻辑属性 */
  margin-inline-start: 1rem;
  padding-inline-end: 1rem;
}
```

## 10. 小结

| 方案 | 优点 | 缺点 |
|------|------|------|
| 原生 i18n | 无需额外依赖 | 只支持 JSON,不支持嵌套键 |
| @wxt-dev/i18n | YAML 支持,嵌套键,类型安全 | 需要额外安装 |

推荐使用 @wxt-dev/i18n 模块,它提供了更好的开发体验和更强大的功能。
