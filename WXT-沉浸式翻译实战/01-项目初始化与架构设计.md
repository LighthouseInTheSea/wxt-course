# WXT 沉浸式翻译插件实战 - 第一章: 项目初始化与架构设计

## 1.1 项目概述

本系列教程将指导你使用 WXT 框架和 React 构建一个类似"沉浸式翻译"的浏览器插件。该插件能够:

- 识别网页中的文本内容
- 调用翻译 API 进行翻译
- 以双语对照的形式展示翻译结果
- 支持多种翻译服务配置
- 提供快捷键和悬浮球交互

### 技术栈

| 技术 | 用途 |
|------|------|
| WXT | 浏览器插件开发框架 |
| React 18 | UI 组件开发 |
| TypeScript | 类型安全 |
| Tailwind CSS | 样式处理 |
| wxt/storage | 数据持久化 |

### 插件架构图

```
+------------------+     +------------------+     +------------------+
|     Popup        |     |   Background     |     |  Content Script  |
|   (React UI)     |<--->|   (Service)      |<--->|   (页面注入)      |
+------------------+     +------------------+     +------------------+
        |                        |                        |
        v                        v                        v
+------------------+     +------------------+     +------------------+
|   用户设置界面    |     |   翻译API调用     |     |   DOM文本提取     |
|   快捷操作入口    |     |   消息中转站      |     |   译文UI渲染      |
+------------------+     +------------------+     +------------------+
```

## 1.2 创建项目

### 初始化 WXT 项目

```bash
# 创建项目
pnpm dlx wxt@latest init immersive-translate-clone

# 进入项目目录
cd immersive-translate-clone

# 选择模板时选择: react
```

### 安装依赖

```bash
# 安装核心依赖
pnpm install

# 安装额外依赖
pnpm add -D tailwindcss postcss autoprefixer
pnpm add @tanstack/react-query
pnpm add clsx

# 初始化 Tailwind
pnpm dlx tailwindcss init -p
```

## 1.3 项目配置

### wxt.config.ts

```typescript
import { defineConfig } from 'wxt';

export default defineConfig({
  // 使用 React 模块
  modules: ['@wxt-dev/module-react'],
  
  // 源码目录
  srcDir: 'src',
  
  // Manifest 配置
  manifest: {
    name: 'Immersive Translate Clone',
    description: '沉浸式双语网页翻译插件',
    version: '1.0.0',
    
    // 权限声明
    permissions: [
      'storage',
      'activeTab',
      'contextMenus',
    ],
    
    // 可选权限(按需申请)
    optional_permissions: [
      'tabs',
    ],
    
    // 主机权限
    host_permissions: [
      '<all_urls>',
    ],
    
    // 快捷键
    commands: {
      'toggle-translate': {
        suggested_key: {
          default: 'Alt+T',
          mac: 'Alt+T',
        },
        description: '切换翻译状态',
      },
    },
  },
  
  // 开发服务器配置
  dev: {
    server: {
      port: 3000,
    },
  },
});
```

### tailwind.config.js

```javascript
/** @type {import('tailwindcss').Config} */
export default {
  content: [
    './src/**/*.{js,ts,jsx,tsx,html}',
  ],
  theme: {
    extend: {
      colors: {
        primary: {
          50: '#eff6ff',
          100: '#dbeafe',
          500: '#3b82f6',
          600: '#2563eb',
          700: '#1d4ed8',
        },
      },
    },
  },
  plugins: [],
  // 防止与页面样式冲突
  prefix: 'it-',
};
```

### src/assets/styles/global.css

```css
@tailwind base;
@tailwind components;
@tailwind utilities;

/* 自定义样式 */
.translate-panel {
  @apply it-bg-white it-rounded-lg it-shadow-lg it-p-4;
}

.translate-text {
  @apply it-text-gray-700 it-leading-relaxed;
}

.original-text {
  @apply it-text-gray-500 it-text-sm it-mb-2;
}
```

## 1.4 目录结构设计

```
src/
├── entrypoints/           # WXT 入口点
│   ├── background.ts      # 后台服务
│   ├── content.tsx        # 内容脚本
│   ├── popup/             # 弹出页面
│   │   ├── index.html
│   │   ├── main.tsx
│   │   └── App.tsx
│   └── options/           # 设置页面
│       ├── index.html
│       ├── main.tsx
│       └── App.tsx
│
├── components/            # React 组件
│   ├── common/            # 通用组件
│   │   ├── Button.tsx
│   │   ├── Select.tsx
│   │   └── Toggle.tsx
│   ├── translate/         # 翻译相关组件
│   │   ├── TranslatePanel.tsx
│   │   ├── TranslateButton.tsx
│   │   └── BilingualText.tsx
│   └── settings/          # 设置相关组件
│       ├── LanguageSelect.tsx
│       └── ServiceConfig.tsx
│
├── hooks/                 # 自定义 Hooks
│   ├── useTranslate.ts
│   ├── useSettings.ts
│   └── useStorage.ts
│
├── services/              # 服务层
│   ├── translate/         # 翻译服务
│   │   ├── index.ts
│   │   ├── google.ts
│   │   ├── deepl.ts
│   │   └── types.ts
│   └── api/               # API 封装
│       └── request.ts
│
├── stores/                # 状态管理
│   └── storage.ts         # WXT Storage 定义
│
├── utils/                 # 工具函数
│   ├── dom.ts             # DOM 操作
│   ├── text.ts            # 文本处理
│   └── language.ts        # 语言检测
│
├── types/                 # 类型定义
│   ├── translate.ts
│   ├── settings.ts
│   └── message.ts
│
└── assets/                # 静态资源
    ├── styles/
    │   └── global.css
    └── icons/
        └── icon.svg
```

## 1.5 核心类型定义

### src/types/translate.ts

```typescript
// 支持的语言
export type LanguageCode = 
  | 'auto'  // 自动检测
  | 'zh-CN' // 简体中文
  | 'zh-TW' // 繁体中文
  | 'en'    // 英语
  | 'ja'    // 日语
  | 'ko'    // 韩语
  | 'fr'    // 法语
  | 'de'    // 德语
  | 'es'    // 西班牙语
  | 'ru';   // 俄语

// 翻译服务类型
export type TranslateService = 
  | 'google'
  | 'deepl'
  | 'openai'
  | 'custom';

// 翻译请求
export interface TranslateRequest {
  text: string;
  from: LanguageCode;
  to: LanguageCode;
  service?: TranslateService;
}

// 翻译结果
export interface TranslateResult {
  originalText: string;
  translatedText: string;
  from: LanguageCode;
  to: LanguageCode;
  service: TranslateService;
  timestamp: number;
}

// 翻译错误
export interface TranslateError {
  code: string;
  message: string;
  service: TranslateService;
}

// 文本节点信息
export interface TextNode {
  id: string;
  element: HTMLElement;
  originalText: string;
  translatedText?: string;
  isTranslated: boolean;
  rect: DOMRect;
}
```

### src/types/settings.ts

```typescript
import type { LanguageCode, TranslateService } from './translate';

// 翻译模式
export type TranslateMode = 
  | 'bilingual'    // 双语对照
  | 'replace'      // 替换原文
  | 'hover';       // 悬停显示

// 触发方式
export type TriggerMode = 
  | 'auto'         // 自动翻译
  | 'manual'       // 手动触发
  | 'select';      // 选中翻译

// 用户设置
export interface UserSettings {
  // 基础设置
  enabled: boolean;
  translateMode: TranslateMode;
  triggerMode: TriggerMode;
  
  // 语言设置
  sourceLanguage: LanguageCode;
  targetLanguage: LanguageCode;
  
  // 翻译服务
  primaryService: TranslateService;
  fallbackService?: TranslateService;
  
  // API 配置
  apiKeys: {
    google?: string;
    deepl?: string;
    openai?: string;
  };
  
  // 自定义 API
  customApi?: {
    url: string;
    method: 'GET' | 'POST';
    headers?: Record<string, string>;
  };
  
  // 显示设置
  fontSize: number;
  showOriginal: boolean;
  highlightTranslated: boolean;
  
  // 快捷键
  shortcut: string;
  
  // 排除规则
  excludedDomains: string[];
  excludedSelectors: string[];
}

// 默认设置
export const defaultSettings: UserSettings = {
  enabled: true,
  translateMode: 'bilingual',
  triggerMode: 'manual',
  sourceLanguage: 'auto',
  targetLanguage: 'zh-CN',
  primaryService: 'google',
  apiKeys: {},
  fontSize: 14,
  showOriginal: true,
  highlightTranslated: true,
  shortcut: 'Alt+T',
  excludedDomains: [],
  excludedSelectors: [
    'script',
    'style',
    'code',
    'pre',
    'textarea',
    'input',
  ],
};
```

### src/types/message.ts

```typescript
import type { TranslateRequest, TranslateResult } from './translate';
import type { UserSettings } from './settings';

// 消息类型枚举
export enum MessageType {
  // 翻译相关
  TRANSLATE_TEXT = 'TRANSLATE_TEXT',
  TRANSLATE_PAGE = 'TRANSLATE_PAGE',
  TRANSLATE_RESULT = 'TRANSLATE_RESULT',
  
  // 设置相关
  GET_SETTINGS = 'GET_SETTINGS',
  UPDATE_SETTINGS = 'UPDATE_SETTINGS',
  SETTINGS_CHANGED = 'SETTINGS_CHANGED',
  
  // 状态相关
  GET_STATUS = 'GET_STATUS',
  TOGGLE_TRANSLATE = 'TOGGLE_TRANSLATE',
}

// 消息基础结构
export interface BaseMessage {
  type: MessageType;
  timestamp: number;
}

// 翻译请求消息
export interface TranslateTextMessage extends BaseMessage {
  type: MessageType.TRANSLATE_TEXT;
  payload: TranslateRequest;
}

// 翻译结果消息
export interface TranslateResultMessage extends BaseMessage {
  type: MessageType.TRANSLATE_RESULT;
  payload: TranslateResult;
}

// 设置更新消息
export interface UpdateSettingsMessage extends BaseMessage {
  type: MessageType.UPDATE_SETTINGS;
  payload: Partial<UserSettings>;
}

// 联合消息类型
export type ExtensionMessage = 
  | TranslateTextMessage
  | TranslateResultMessage
  | UpdateSettingsMessage;

// 消息响应
export interface MessageResponse<T = unknown> {
  success: boolean;
  data?: T;
  error?: string;
}
```

## 1.6 Storage 定义

### src/stores/storage.ts

```typescript
import { storage } from 'wxt/storage';
import type { UserSettings } from '@/types/settings';
import type { TranslateResult } from '@/types/translate';
import { defaultSettings } from '@/types/settings';

// 用户设置 (同步存储)
export const settingsStorage = storage.defineItem<UserSettings>(
  'sync:settings',
  {
    fallback: defaultSettings,
  }
);

// 翻译历史 (本地存储)
export const historyStorage = storage.defineItem<TranslateResult[]>(
  'local:history',
  {
    fallback: [],
  }
);

// 翻译缓存 (会话存储)
export const cacheStorage = storage.defineItem<Record<string, string>>(
  'session:translateCache',
  {
    fallback: {},
  }
);

// 当前页面翻译状态 (会话存储)
export const pageStatusStorage = storage.defineItem<Record<string, boolean>>(
  'session:pageStatus',
  {
    fallback: {},
  }
);

// 辅助函数: 添加历史记录
export async function addToHistory(result: TranslateResult): Promise<void> {
  const history = await historyStorage.getValue();
  const maxHistory = 1000;
  
  // 添加到开头,限制数量
  const newHistory = [result, ...history].slice(0, maxHistory);
  await historyStorage.setValue(newHistory);
}

// 辅助函数: 获取缓存
export async function getFromCache(text: string): Promise<string | null> {
  const cache = await cacheStorage.getValue();
  return cache[text] || null;
}

// 辅助函数: 设置缓存
export async function setToCache(text: string, translated: string): Promise<void> {
  const cache = await cacheStorage.getValue();
  cache[text] = translated;
  await cacheStorage.setValue(cache);
}
```

## 1.7 运行项目

```bash
# 开发模式
pnpm dev

# 构建 Chrome 版本
pnpm build

# 构建 Firefox 版本
pnpm build:firefox

# 打包发布
pnpm zip
```

### 加载插件到浏览器

**Chrome:**
1. 打开 `chrome://extensions/`
2. 开启"开发者模式"
3. 点击"加载已解压的扩展程序"
4. 选择 `.output/chrome-mv3` 目录

**Firefox:**
1. 打开 `about:debugging#/runtime/this-firefox`
2. 点击"临时加载附加组件"
3. 选择 `.output/firefox-mv2/manifest.json`

## 1.8 本章小结

本章完成了:

1. 项目初始化和依赖安装
2. WXT 配置和 Tailwind 集成
3. 目录结构规划
4. 核心类型定义
5. Storage 存储层设计

下一章我们将实现后台服务(Background Service),处理翻译请求和消息通信。
