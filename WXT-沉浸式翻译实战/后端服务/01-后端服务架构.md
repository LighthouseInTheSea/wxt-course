# 沉浸式翻译插件 - 后端服务架构

## 概述

本章节介绍如何使用 Hono + Drizzle ORM + PostgreSQL 构建沉浸式翻译插件的后端服务,包括项目初始化、数据库设计、API 路由等核心内容。

## 1. 项目初始化

### 1.1 创建项目

```bash
# 创建项目目录
mkdir immersive-translator-api
cd immersive-translator-api

# 初始化
pnpm init

# 安装核心依赖
pnpm add hono @hono/node-server
pnpm add drizzle-orm postgres
pnpm add better-auth
pnpm add zod
pnpm add dotenv

# 安装开发依赖
pnpm add -D typescript @types/node tsx
pnpm add -D drizzle-kit
pnpm add -D @types/better-auth
```

### 1.2 TypeScript 配置

```json
// tsconfig.json
{
  "compilerOptions": {
    "target": "ES2022",
    "module": "ESNext",
    "moduleResolution": "bundler",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true,
    "outDir": "./dist",
    "rootDir": "./src",
    "declaration": true,
    "paths": {
      "@/*": ["./src/*"]
    }
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules", "dist"]
}
```

### 1.3 项目结构

```
immersive-translator-api/
├── src/
│   ├── index.ts              # 应用入口
│   ├── app.ts                # Hono 应用配置
│   ├── db/
│   │   ├── index.ts          # 数据库连接
│   │   ├── schema/           # 数据库 Schema
│   │   │   ├── index.ts
│   │   │   ├── users.ts
│   │   │   ├── subscriptions.ts
│   │   │   └── translations.ts
│   │   └── migrations/       # 数据库迁移
│   ├── routes/
│   │   ├── index.ts          # 路由汇总
│   │   ├── auth.ts           # 认证路由
│   │   ├── translation.ts    # 翻译 API
│   │   ├── subscription.ts   # 订阅管理
│   │   └── webhook.ts        # 支付回调
│   ├── services/
│   │   ├── translator.ts     # 翻译服务
│   │   ├── payment/          # 支付服务
│   │   │   ├── index.ts      # 支付接口
│   │   │   ├── creem.ts      # Creem 实现
│   │   │   └── stripe.ts     # Stripe 实现
│   │   └── ai.ts             # AI 服务
│   ├── middleware/
│   │   ├── auth.ts           # 认证中间件
│   │   ├── rateLimit.ts      # 限流中间件
│   │   └── membership.ts     # 会员验证
│   ├── lib/
│   │   ├── auth.ts           # better-auth 配置
│   │   └── env.ts            # 环境变量
│   └── types/
│       └── index.ts          # 类型定义
├── drizzle.config.ts         # Drizzle 配置
├── package.json
└── .env
```

### 1.4 环境变量

```bash
# .env
# 数据库
DATABASE_URL=postgresql://user:password@localhost:5432/immersive_translator

# 认证
BETTER_AUTH_SECRET=your-secret-key-min-32-chars
BETTER_AUTH_URL=http://localhost:3000

# OAuth
GOOGLE_CLIENT_ID=your-google-client-id
GOOGLE_CLIENT_SECRET=your-google-client-secret
GITHUB_CLIENT_ID=your-github-client-id
GITHUB_CLIENT_SECRET=your-github-client-secret

# 邮件
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password

# 支付
CREEM_API_KEY=your-creem-api-key
CREEM_WEBHOOK_SECRET=your-creem-webhook-secret
STRIPE_SECRET_KEY=your-stripe-secret-key
STRIPE_WEBHOOK_SECRET=your-stripe-webhook-secret

# AI 服务
OPENAI_API_KEY=your-openai-api-key
DEEPL_API_KEY=your-deepl-api-key

# 应用
NODE_ENV=development
PORT=3000
FRONTEND_URL=http://localhost:5173
```

```typescript
// src/lib/env.ts
import { z } from 'zod';
import dotenv from 'dotenv';

dotenv.config();

const envSchema = z.object({
  DATABASE_URL: z.string().url(),
  BETTER_AUTH_SECRET: z.string().min(32),
  BETTER_AUTH_URL: z.string().url(),
  GOOGLE_CLIENT_ID: z.string(),
  GOOGLE_CLIENT_SECRET: z.string(),
  GITHUB_CLIENT_ID: z.string(),
  GITHUB_CLIENT_SECRET: z.string(),
  CREEM_API_KEY: z.string(),
  CREEM_WEBHOOK_SECRET: z.string(),
  STRIPE_SECRET_KEY: z.string().optional(),
  STRIPE_WEBHOOK_SECRET: z.string().optional(),
  OPENAI_API_KEY: z.string(),
  NODE_ENV: z.enum(['development', 'production', 'test']).default('development'),
  PORT: z.string().transform(Number).default('3000'),
  FRONTEND_URL: z.string().url(),
});

export const env = envSchema.parse(process.env);
```

## 2. 数据库设计

### 2.1 Drizzle 配置

```typescript
// drizzle.config.ts
import { defineConfig } from 'drizzle-kit';

export default defineConfig({
  schema: './src/db/schema/index.ts',
  out: './src/db/migrations',
  dialect: 'postgresql',
  dbCredentials: {
    url: process.env.DATABASE_URL!,
  },
  verbose: true,
  strict: true,
});
```

### 2.2 数据库连接

```typescript
// src/db/index.ts
import { drizzle } from 'drizzle-orm/postgres-js';
import postgres from 'postgres';
import * as schema from './schema';
import { env } from '@/lib/env';

const client = postgres(env.DATABASE_URL);

export const db = drizzle(client, { schema });

export type Database = typeof db;
```

### 2.3 Schema 定义

```typescript
// src/db/schema/users.ts
import { pgTable, text, timestamp, boolean, uuid } from 'drizzle-orm/pg-core';
import { relations } from 'drizzle-orm';

export const users = pgTable('users', {
  id: uuid('id').primaryKey().defaultRandom(),
  email: text('email').unique().notNull(),
  name: text('name'),
  image: text('image'),
  emailVerified: boolean('email_verified').default(false),
  createdAt: timestamp('created_at').defaultNow().notNull(),
  updatedAt: timestamp('updated_at').defaultNow().notNull(),
});

export const sessions = pgTable('sessions', {
  id: uuid('id').primaryKey().defaultRandom(),
  userId: uuid('user_id').references(() => users.id, { onDelete: 'cascade' }).notNull(),
  token: text('token').unique().notNull(),
  expiresAt: timestamp('expires_at').notNull(),
  ipAddress: text('ip_address'),
  userAgent: text('user_agent'),
  createdAt: timestamp('created_at').defaultNow().notNull(),
});

export const accounts = pgTable('accounts', {
  id: uuid('id').primaryKey().defaultRandom(),
  userId: uuid('user_id').references(() => users.id, { onDelete: 'cascade' }).notNull(),
  provider: text('provider').notNull(), // google, github, email
  providerAccountId: text('provider_account_id').notNull(),
  accessToken: text('access_token'),
  refreshToken: text('refresh_token'),
  expiresAt: timestamp('expires_at'),
  createdAt: timestamp('created_at').defaultNow().notNull(),
});

export const verificationTokens = pgTable('verification_tokens', {
  id: uuid('id').primaryKey().defaultRandom(),
  email: text('email').notNull(),
  token: text('token').unique().notNull(),
  expiresAt: timestamp('expires_at').notNull(),
  createdAt: timestamp('created_at').defaultNow().notNull(),
});

// Relations
export const usersRelations = relations(users, ({ many }) => ({
  sessions: many(sessions),
  accounts: many(accounts),
}));

export const sessionsRelations = relations(sessions, ({ one }) => ({
  user: one(users, {
    fields: [sessions.userId],
    references: [users.id],
  }),
}));
```

```typescript
// src/db/schema/subscriptions.ts
import { pgTable, text, timestamp, uuid, integer, pgEnum, jsonb } from 'drizzle-orm/pg-core';
import { relations } from 'drizzle-orm';
import { users } from './users';

// 订阅状态枚举
export const subscriptionStatusEnum = pgEnum('subscription_status', [
  'active',
  'canceled',
  'past_due',
  'trialing',
  'expired',
]);

// 订阅计划枚举
export const planTypeEnum = pgEnum('plan_type', [
  'free',
  'pro_monthly',
  'pro_yearly',
  'lifetime',
]);

// 支付渠道枚举
export const paymentProviderEnum = pgEnum('payment_provider', [
  'creem',
  'stripe',
  'paddle',
  'lemonsqueezy',
]);

export const plans = pgTable('plans', {
  id: uuid('id').primaryKey().defaultRandom(),
  name: text('name').notNull(),
  type: planTypeEnum('type').notNull(),
  price: integer('price').notNull(), // 以分为单位
  currency: text('currency').default('USD').notNull(),
  interval: text('interval'), // month, year, null for lifetime
  features: jsonb('features').$type<string[]>().default([]),
  stripePriceId: text('stripe_price_id'),
  creemProductId: text('creem_product_id'),
  isActive: boolean('is_active').default(true),
  createdAt: timestamp('created_at').defaultNow().notNull(),
});

export const subscriptions = pgTable('subscriptions', {
  id: uuid('id').primaryKey().defaultRandom(),
  userId: uuid('user_id').references(() => users.id, { onDelete: 'cascade' }).notNull(),
  planId: uuid('plan_id').references(() => plans.id).notNull(),
  status: subscriptionStatusEnum('status').default('active').notNull(),
  provider: paymentProviderEnum('provider').notNull(),
  providerSubscriptionId: text('provider_subscription_id'),
  providerCustomerId: text('provider_customer_id'),
  currentPeriodStart: timestamp('current_period_start'),
  currentPeriodEnd: timestamp('current_period_end'),
  cancelAtPeriodEnd: boolean('cancel_at_period_end').default(false),
  canceledAt: timestamp('canceled_at'),
  metadata: jsonb('metadata').$type<Record<string, unknown>>(),
  createdAt: timestamp('created_at').defaultNow().notNull(),
  updatedAt: timestamp('updated_at').defaultNow().notNull(),
});

export const payments = pgTable('payments', {
  id: uuid('id').primaryKey().defaultRandom(),
  userId: uuid('user_id').references(() => users.id, { onDelete: 'set null' }),
  subscriptionId: uuid('subscription_id').references(() => subscriptions.id, { onDelete: 'set null' }),
  provider: paymentProviderEnum('provider').notNull(),
  providerPaymentId: text('provider_payment_id').unique(),
  amount: integer('amount').notNull(),
  currency: text('currency').default('USD').notNull(),
  status: text('status').notNull(), // succeeded, pending, failed
  metadata: jsonb('metadata').$type<Record<string, unknown>>(),
  createdAt: timestamp('created_at').defaultNow().notNull(),
});

// Relations
export const subscriptionsRelations = relations(subscriptions, ({ one }) => ({
  user: one(users, {
    fields: [subscriptions.userId],
    references: [users.id],
  }),
  plan: one(plans, {
    fields: [subscriptions.planId],
    references: [plans.id],
  }),
}));

import { boolean } from 'drizzle-orm/pg-core';
```

```typescript
// src/db/schema/translations.ts
import { pgTable, text, timestamp, uuid, integer } from 'drizzle-orm/pg-core';
import { relations } from 'drizzle-orm';
import { users } from './users';

// 翻译使用量记录
export const translationUsage = pgTable('translation_usage', {
  id: uuid('id').primaryKey().defaultRandom(),
  userId: uuid('user_id').references(() => users.id, { onDelete: 'cascade' }).notNull(),
  date: timestamp('date').defaultNow().notNull(),
  charactersUsed: integer('characters_used').default(0).notNull(),
  requestCount: integer('request_count').default(0).notNull(),
});

// 翻译缓存
export const translationCache = pgTable('translation_cache', {
  id: uuid('id').primaryKey().defaultRandom(),
  sourceText: text('source_text').notNull(),
  sourceHash: text('source_hash').notNull(), // MD5 hash for quick lookup
  sourceLang: text('source_lang'),
  targetLang: text('target_lang').notNull(),
  translatedText: text('translated_text').notNull(),
  provider: text('provider').notNull(), // openai, deepl, google
  createdAt: timestamp('created_at').defaultNow().notNull(),
  hitCount: integer('hit_count').default(0).notNull(),
});

export const translationUsageRelations = relations(translationUsage, ({ one }) => ({
  user: one(users, {
    fields: [translationUsage.userId],
    references: [users.id],
  }),
}));
```

```typescript
// src/db/schema/index.ts
export * from './users';
export * from './subscriptions';
export * from './translations';
```

### 2.4 数据库迁移

```bash
# 生成迁移文件
pnpm drizzle-kit generate

# 执行迁移
pnpm drizzle-kit push

# 查看数据库状态
pnpm drizzle-kit studio
```

## 3. Hono 应用配置

### 3.1 应用入口

```typescript
// src/app.ts
import { Hono } from 'hono';
import { cors } from 'hono/cors';
import { logger } from 'hono/logger';
import { timing } from 'hono/timing';
import { secureHeaders } from 'hono/secure-headers';
import { requestId } from 'hono/request-id';

import { env } from '@/lib/env';
import { authRoutes } from '@/routes/auth';
import { translationRoutes } from '@/routes/translation';
import { subscriptionRoutes } from '@/routes/subscription';
import { webhookRoutes } from '@/routes/webhook';
import { landingRoutes } from '@/routes/landing';

// 类型定义
export type Env = {
  Variables: {
    user: {
      id: string;
      email: string;
      name: string | null;
    } | null;
    requestId: string;
  };
};

const app = new Hono<Env>();

// 全局中间件
app.use('*', requestId());
app.use('*', logger());
app.use('*', timing());
app.use('*', secureHeaders());

// CORS 配置
app.use('*', cors({
  origin: [env.FRONTEND_URL, 'chrome-extension://*', 'moz-extension://*'],
  credentials: true,
  allowMethods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],
  allowHeaders: ['Content-Type', 'Authorization'],
  maxAge: 86400,
}));

// 健康检查
app.get('/health', (c) => c.json({ status: 'ok', timestamp: new Date().toISOString() }));

// API 路由
app.route('/api/auth', authRoutes);
app.route('/api/translate', translationRoutes);
app.route('/api/subscription', subscriptionRoutes);
app.route('/api/webhook', webhookRoutes);

// 页面路由
app.route('/', landingRoutes);

// 404 处理
app.notFound((c) => {
  return c.json({ error: 'Not Found' }, 404);
});

// 错误处理
app.onError((err, c) => {
  console.error('Server Error:', err);
  return c.json(
    { 
      error: env.NODE_ENV === 'production' ? 'Internal Server Error' : err.message,
    },
    500
  );
});

export default app;
```

### 3.2 服务入口

```typescript
// src/index.ts
import { serve } from '@hono/node-server';
import app from './app';
import { env } from '@/lib/env';

const port = env.PORT;

console.log(`Server starting on port ${port}...`);

serve({
  fetch: app.fetch,
  port,
});

console.log(`Server running at http://localhost:${port}`);
```

## 4. 类型定义

```typescript
// src/types/index.ts
import { InferSelectModel, InferInsertModel } from 'drizzle-orm';
import { users, subscriptions, plans, payments } from '@/db/schema';

// 用户类型
export type User = InferSelectModel<typeof users>;
export type NewUser = InferInsertModel<typeof users>;

// 订阅类型
export type Subscription = InferSelectModel<typeof subscriptions>;
export type NewSubscription = InferInsertModel<typeof subscriptions>;

// 计划类型
export type Plan = InferSelectModel<typeof plans>;

// 支付类型
export type Payment = InferSelectModel<typeof payments>;
export type NewPayment = InferInsertModel<typeof payments>;

// 会员信息
export interface MembershipInfo {
  type: 'free' | 'pro';
  plan?: Plan;
  subscription?: Subscription;
  expiresAt?: string;
  features: string[];
}

// 翻译请求
export interface TranslationRequest {
  texts: string[];
  targetLang: string;
  sourceLang?: string;
}

// 翻译响应
export interface TranslationResponse {
  translations: string[];
  sourceLang: string;
  targetLang: string;
  cached: boolean[];
}

// 支付提供商接口
export interface PaymentProvider {
  name: string;
  createCheckoutSession(params: CheckoutParams): Promise<CheckoutSession>;
  createCustomerPortalSession(customerId: string): Promise<{ url: string }>;
  handleWebhook(payload: string, signature: string): Promise<WebhookEvent>;
  cancelSubscription(subscriptionId: string): Promise<void>;
}

export interface CheckoutParams {
  userId: string;
  email: string;
  planId: string;
  successUrl: string;
  cancelUrl: string;
}

export interface CheckoutSession {
  id: string;
  url: string;
}

export interface WebhookEvent {
  type: 'subscription.created' | 'subscription.updated' | 'subscription.canceled' | 'payment.succeeded' | 'payment.failed';
  data: Record<string, unknown>;
}
```

## 5. package.json 脚本

```json
{
  "name": "immersive-translator-api",
  "version": "1.0.0",
  "type": "module",
  "scripts": {
    "dev": "tsx watch src/index.ts",
    "build": "tsc",
    "start": "node dist/index.js",
    "db:generate": "drizzle-kit generate",
    "db:push": "drizzle-kit push",
    "db:migrate": "drizzle-kit migrate",
    "db:studio": "drizzle-kit studio",
    "db:seed": "tsx src/db/seed.ts",
    "typecheck": "tsc --noEmit"
  },
  "dependencies": {
    "@hono/node-server": "^1.13.0",
    "better-auth": "^1.0.0",
    "dotenv": "^16.4.5",
    "drizzle-orm": "^0.34.0",
    "hono": "^4.6.0",
    "postgres": "^3.4.4",
    "zod": "^3.23.8"
  },
  "devDependencies": {
    "@types/node": "^22.0.0",
    "drizzle-kit": "^0.26.0",
    "tsx": "^4.19.0",
    "typescript": "^5.6.0"
  }
}
```

## 总结

本章节完成了:

1. **项目初始化** - Hono + TypeScript 项目结构
2. **数据库设计** - 用户、订阅、支付、翻译相关表结构
3. **Drizzle ORM 集成** - Schema 定义、关系配置、迁移管理
4. **Hono 应用配置** - 中间件、路由、错误处理
5. **类型系统** - 完整的 TypeScript 类型定义

下一章将介绍认证系统的实现,包括 better-auth 集成和 OAuth 配置。
