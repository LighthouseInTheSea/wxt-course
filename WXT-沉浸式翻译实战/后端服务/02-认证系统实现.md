# 沉浸式翻译插件 - 认证系统实现

## 概述

本章节介绍如何使用 better-auth 实现完整的认证系统,支持 Google、GitHub OAuth 登录以及邮箱密码登录。

## 1. better-auth 配置

### 1.1 核心配置

```typescript
// src/lib/auth.ts
import { betterAuth } from 'better-auth';
import { drizzleAdapter } from 'better-auth/adapters/drizzle';
import { db } from '@/db';
import { env } from '@/lib/env';
import * as schema from '@/db/schema';

export const auth = betterAuth({
  // 数据库适配器
  database: drizzleAdapter(db, {
    provider: 'pg',
    schema: {
      user: schema.users,
      session: schema.sessions,
      account: schema.accounts,
      verification: schema.verificationTokens,
    },
  }),

  // 基础配置
  secret: env.BETTER_AUTH_SECRET,
  baseURL: env.BETTER_AUTH_URL,
  trustedOrigins: [env.FRONTEND_URL],

  // 邮箱密码登录
  emailAndPassword: {
    enabled: true,
    requireEmailVerification: true,
    sendResetPassword: async ({ user, url }) => {
      await sendEmail({
        to: user.email,
        subject: 'Reset your password',
        template: 'reset-password',
        data: { resetUrl: url, name: user.name },
      });
    },
  },

  // 邮箱验证
  emailVerification: {
    sendVerificationEmail: async ({ user, url }) => {
      await sendEmail({
        to: user.email,
        subject: 'Verify your email',
        template: 'verify-email',
        data: { verifyUrl: url, name: user.name },
      });
    },
    sendOnSignUp: true,
  },

  // OAuth 提供商
  socialProviders: {
    google: {
      clientId: env.GOOGLE_CLIENT_ID,
      clientSecret: env.GOOGLE_CLIENT_SECRET,
      scope: ['email', 'profile'],
    },
    github: {
      clientId: env.GITHUB_CLIENT_ID,
      clientSecret: env.GITHUB_CLIENT_SECRET,
      scope: ['user:email'],
    },
  },

  // Session 配置
  session: {
    expiresIn: 60 * 60 * 24 * 7, // 7 days
    updateAge: 60 * 60 * 24, // 1 day
    cookieCache: {
      enabled: true,
      maxAge: 60 * 5, // 5 minutes
    },
  },

  // Cookie 配置
  cookies: {
    sessionToken: {
      name: 'session_token',
      options: {
        httpOnly: true,
        sameSite: 'lax',
        path: '/',
        secure: env.NODE_ENV === 'production',
      },
    },
  },

  // 回调
  callbacks: {
    session: async ({ session, user }) => {
      // 添加额外的会话数据
      return {
        ...session,
        user: {
          ...session.user,
          id: user.id,
        },
      };
    },
  },

  // 高级配置
  advanced: {
    generateId: () => crypto.randomUUID(),
    cookiePrefix: 'immersive_translator',
  },
});

// 导出类型
export type Session = typeof auth.$Infer.Session;
export type User = typeof auth.$Infer.Session.user;
```

### 1.2 邮件发送服务

```typescript
// src/services/email.ts
import nodemailer from 'nodemailer';
import { env } from '@/lib/env';

const transporter = nodemailer.createTransport({
  host: env.SMTP_HOST,
  port: Number(env.SMTP_PORT),
  secure: env.SMTP_PORT === '465',
  auth: {
    user: env.SMTP_USER,
    pass: env.SMTP_PASS,
  },
});

interface EmailParams {
  to: string;
  subject: string;
  template: 'verify-email' | 'reset-password' | 'welcome';
  data: Record<string, string | undefined>;
}

const templates = {
  'verify-email': (data: Record<string, string | undefined>) => ({
    subject: 'Verify your email - Immersive Translator',
    html: `
      <div style="max-width: 600px; margin: 0 auto; padding: 20px; font-family: sans-serif;">
        <h1 style="color: #1a73e8;">Verify Your Email</h1>
        <p>Hi ${data.name || 'there'},</p>
        <p>Please click the button below to verify your email address:</p>
        <a href="${data.verifyUrl}" 
           style="display: inline-block; padding: 12px 24px; background: #1a73e8; color: white; text-decoration: none; border-radius: 6px; margin: 20px 0;">
          Verify Email
        </a>
        <p style="color: #666; font-size: 14px;">
          If you didn't create an account, you can safely ignore this email.
        </p>
        <p style="color: #666; font-size: 14px;">
          Or copy this link: ${data.verifyUrl}
        </p>
      </div>
    `,
  }),

  'reset-password': (data: Record<string, string | undefined>) => ({
    subject: 'Reset your password - Immersive Translator',
    html: `
      <div style="max-width: 600px; margin: 0 auto; padding: 20px; font-family: sans-serif;">
        <h1 style="color: #1a73e8;">Reset Your Password</h1>
        <p>Hi ${data.name || 'there'},</p>
        <p>You requested to reset your password. Click the button below:</p>
        <a href="${data.resetUrl}" 
           style="display: inline-block; padding: 12px 24px; background: #1a73e8; color: white; text-decoration: none; border-radius: 6px; margin: 20px 0;">
          Reset Password
        </a>
        <p style="color: #666; font-size: 14px;">
          This link will expire in 1 hour.
        </p>
        <p style="color: #666; font-size: 14px;">
          If you didn't request this, you can safely ignore this email.
        </p>
      </div>
    `,
  }),

  'welcome': (data: Record<string, string | undefined>) => ({
    subject: 'Welcome to Immersive Translator!',
    html: `
      <div style="max-width: 600px; margin: 0 auto; padding: 20px; font-family: sans-serif;">
        <h1 style="color: #1a73e8;">Welcome to Immersive Translator!</h1>
        <p>Hi ${data.name || 'there'},</p>
        <p>Thank you for joining Immersive Translator. You can now:</p>
        <ul>
          <li>Translate any web page with bilingual reading</li>
          <li>Sync your settings across devices</li>
          <li>Access premium features with Pro membership</li>
        </ul>
        <a href="${env.FRONTEND_URL}" 
           style="display: inline-block; padding: 12px 24px; background: #1a73e8; color: white; text-decoration: none; border-radius: 6px; margin: 20px 0;">
          Get Started
        </a>
      </div>
    `,
  }),
};

export async function sendEmail(params: EmailParams): Promise<void> {
  const template = templates[params.template](params.data);

  await transporter.sendMail({
    from: `"Immersive Translator" <${env.SMTP_USER}>`,
    to: params.to,
    subject: params.subject || template.subject,
    html: template.html,
  });
}
```

## 2. 认证路由

### 2.1 Hono 集成

```typescript
// src/routes/auth.ts
import { Hono } from 'hono';
import { auth } from '@/lib/auth';
import type { Env } from '@/app';

export const authRoutes = new Hono<Env>();

// better-auth 处理所有认证请求
authRoutes.on(['GET', 'POST'], '/*', async (c) => {
  return auth.handler(c.req.raw);
});
```

### 2.2 认证中间件

```typescript
// src/middleware/auth.ts
import { createMiddleware } from 'hono/factory';
import { auth } from '@/lib/auth';
import type { Env } from '@/app';

// 验证用户登录状态
export const requireAuth = createMiddleware<Env>(async (c, next) => {
  const session = await auth.api.getSession({
    headers: c.req.raw.headers,
  });

  if (!session) {
    return c.json({ error: 'Unauthorized' }, 401);
  }

  c.set('user', session.user);
  await next();
});

// 可选认证 - 用户可以未登录
export const optionalAuth = createMiddleware<Env>(async (c, next) => {
  try {
    const session = await auth.api.getSession({
      headers: c.req.raw.headers,
    });
    c.set('user', session?.user || null);
  } catch {
    c.set('user', null);
  }
  await next();
});
```

### 2.3 会员验证中间件

```typescript
// src/middleware/membership.ts
import { createMiddleware } from 'hono/factory';
import { db } from '@/db';
import { subscriptions, plans } from '@/db/schema';
import { eq, and, gt } from 'drizzle-orm';
import type { Env } from '@/app';

export const requirePro = createMiddleware<Env>(async (c, next) => {
  const user = c.get('user');
  
  if (!user) {
    return c.json({ error: 'Unauthorized' }, 401);
  }

  // 检查有效订阅
  const subscription = await db.query.subscriptions.findFirst({
    where: and(
      eq(subscriptions.userId, user.id),
      eq(subscriptions.status, 'active'),
      gt(subscriptions.currentPeriodEnd, new Date())
    ),
    with: {
      plan: true,
    },
  });

  if (!subscription || subscription.plan.type === 'free') {
    return c.json({ 
      error: 'Pro membership required',
      code: 'PRO_REQUIRED',
    }, 403);
  }

  await next();
});

// 获取用户会员信息
export async function getMembershipInfo(userId: string) {
  const subscription = await db.query.subscriptions.findFirst({
    where: and(
      eq(subscriptions.userId, userId),
      eq(subscriptions.status, 'active')
    ),
    with: {
      plan: true,
    },
    orderBy: (subscriptions, { desc }) => [desc(subscriptions.createdAt)],
  });

  if (!subscription) {
    return {
      type: 'free' as const,
      features: ['Basic translation', '1000 characters/day'],
    };
  }

  const isExpired = subscription.currentPeriodEnd && 
    new Date(subscription.currentPeriodEnd) < new Date();

  if (isExpired) {
    return {
      type: 'free' as const,
      features: ['Basic translation', '1000 characters/day'],
      expiredSubscription: subscription,
    };
  }

  return {
    type: 'pro' as const,
    plan: subscription.plan,
    subscription,
    expiresAt: subscription.currentPeriodEnd?.toISOString(),
    features: subscription.plan.features as string[],
  };
}
```

## 3. 客户端集成

### 3.1 better-auth 客户端

```typescript
// 浏览器插件: src/lib/auth-client.ts
import { createAuthClient } from 'better-auth/client';

const API_BASE_URL = import.meta.env.VITE_API_BASE_URL;

export const authClient = createAuthClient({
  baseURL: API_BASE_URL,
  credentials: 'include',
});

// 导出便捷方法
export const signIn = authClient.signIn;
export const signUp = authClient.signUp;
export const signOut = authClient.signOut;
export const useSession = authClient.useSession;
```

### 3.2 React 认证 Hook

```typescript
// src/hooks/useAuth.ts
import { useState, useEffect, useCallback } from 'react';
import { authClient } from '@/lib/auth-client';

interface User {
  id: string;
  email: string;
  name: string | null;
  image: string | null;
}

interface AuthState {
  user: User | null;
  loading: boolean;
  error: string | null;
}

export function useAuth() {
  const [state, setState] = useState<AuthState>({
    user: null,
    loading: true,
    error: null,
  });

  useEffect(() => {
    authClient.getSession().then((session) => {
      setState({
        user: session?.user || null,
        loading: false,
        error: null,
      });
    }).catch((error) => {
      setState({
        user: null,
        loading: false,
        error: error.message,
      });
    });
  }, []);

  const signInWithGoogle = useCallback(async () => {
    try {
      await authClient.signIn.social({
        provider: 'google',
        callbackURL: window.location.origin + '/auth/callback',
      });
    } catch (error) {
      setState(prev => ({ 
        ...prev, 
        error: error instanceof Error ? error.message : 'Sign in failed' 
      }));
    }
  }, []);

  const signInWithGitHub = useCallback(async () => {
    try {
      await authClient.signIn.social({
        provider: 'github',
        callbackURL: window.location.origin + '/auth/callback',
      });
    } catch (error) {
      setState(prev => ({ 
        ...prev, 
        error: error instanceof Error ? error.message : 'Sign in failed' 
      }));
    }
  }, []);

  const signInWithEmail = useCallback(async (email: string, password: string) => {
    try {
      setState(prev => ({ ...prev, loading: true, error: null }));
      const result = await authClient.signIn.email({
        email,
        password,
      });
      if (result.user) {
        setState({
          user: result.user,
          loading: false,
          error: null,
        });
      }
      return result;
    } catch (error) {
      const message = error instanceof Error ? error.message : 'Sign in failed';
      setState(prev => ({ ...prev, loading: false, error: message }));
      throw error;
    }
  }, []);

  const signUpWithEmail = useCallback(async (email: string, password: string, name: string) => {
    try {
      setState(prev => ({ ...prev, loading: true, error: null }));
      const result = await authClient.signUp.email({
        email,
        password,
        name,
      });
      setState(prev => ({ ...prev, loading: false }));
      return result;
    } catch (error) {
      const message = error instanceof Error ? error.message : 'Sign up failed';
      setState(prev => ({ ...prev, loading: false, error: message }));
      throw error;
    }
  }, []);

  const signOut = useCallback(async () => {
    try {
      await authClient.signOut();
      setState({ user: null, loading: false, error: null });
    } catch (error) {
      setState(prev => ({ 
        ...prev, 
        error: error instanceof Error ? error.message : 'Sign out failed' 
      }));
    }
  }, []);

  const resetPassword = useCallback(async (email: string) => {
    try {
      await authClient.forgetPassword({ email });
    } catch (error) {
      throw error;
    }
  }, []);

  return {
    ...state,
    isAuthenticated: !!state.user,
    signInWithGoogle,
    signInWithGitHub,
    signInWithEmail,
    signUpWithEmail,
    signOut,
    resetPassword,
  };
}
```

### 3.3 登录组件

```tsx
// src/components/AuthForm.tsx
import React, { useState } from 'react';
import { useAuth } from '@/hooks/useAuth';

type AuthMode = 'signin' | 'signup' | 'forgot';

export function AuthForm() {
  const [mode, setMode] = useState<AuthMode>('signin');
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [name, setName] = useState('');
  const [message, setMessage] = useState('');

  const { 
    loading, 
    error,
    signInWithGoogle, 
    signInWithGitHub,
    signInWithEmail,
    signUpWithEmail,
    resetPassword,
  } = useAuth();

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setMessage('');

    try {
      if (mode === 'signin') {
        await signInWithEmail(email, password);
      } else if (mode === 'signup') {
        await signUpWithEmail(email, password, name);
        setMessage('Please check your email to verify your account.');
        setMode('signin');
      } else if (mode === 'forgot') {
        await resetPassword(email);
        setMessage('Password reset link sent to your email.');
      }
    } catch (err) {
      // Error handled by useAuth
    }
  };

  return (
    <div className="auth-form">
      <h2>
        {mode === 'signin' && 'Sign In'}
        {mode === 'signup' && 'Create Account'}
        {mode === 'forgot' && 'Reset Password'}
      </h2>

      {/* OAuth 按钮 */}
      {mode !== 'forgot' && (
        <div className="oauth-buttons">
          <button 
            type="button"
            onClick={signInWithGoogle}
            className="oauth-btn google"
            disabled={loading}
          >
            <GoogleIcon />
            Continue with Google
          </button>
          
          <button 
            type="button"
            onClick={signInWithGitHub}
            className="oauth-btn github"
            disabled={loading}
          >
            <GitHubIcon />
            Continue with GitHub
          </button>
        </div>
      )}

      {mode !== 'forgot' && <div className="divider">or</div>}

      {/* 邮箱表单 */}
      <form onSubmit={handleSubmit}>
        {mode === 'signup' && (
          <div className="form-group">
            <label htmlFor="name">Name</label>
            <input
              id="name"
              type="text"
              value={name}
              onChange={(e) => setName(e.target.value)}
              placeholder="Your name"
              required
            />
          </div>
        )}

        <div className="form-group">
          <label htmlFor="email">Email</label>
          <input
            id="email"
            type="email"
            value={email}
            onChange={(e) => setEmail(e.target.value)}
            placeholder="you@example.com"
            required
          />
        </div>

        {mode !== 'forgot' && (
          <div className="form-group">
            <label htmlFor="password">Password</label>
            <input
              id="password"
              type="password"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              placeholder="Your password"
              required
              minLength={8}
            />
          </div>
        )}

        {error && <div className="error-message">{error}</div>}
        {message && <div className="success-message">{message}</div>}

        <button type="submit" className="submit-btn" disabled={loading}>
          {loading ? 'Loading...' : (
            mode === 'signin' ? 'Sign In' :
            mode === 'signup' ? 'Create Account' :
            'Send Reset Link'
          )}
        </button>
      </form>

      {/* 切换模式 */}
      <div className="auth-links">
        {mode === 'signin' && (
          <>
            <button type="button" onClick={() => setMode('forgot')}>
              Forgot password?
            </button>
            <button type="button" onClick={() => setMode('signup')}>
              Create an account
            </button>
          </>
        )}
        {mode === 'signup' && (
          <button type="button" onClick={() => setMode('signin')}>
            Already have an account? Sign in
          </button>
        )}
        {mode === 'forgot' && (
          <button type="button" onClick={() => setMode('signin')}>
            Back to sign in
          </button>
        )}
      </div>
    </div>
  );
}

// 图标组件
function GoogleIcon() {
  return (
    <svg viewBox="0 0 24 24" width="20" height="20">
      <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
      <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
      <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
      <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
    </svg>
  );
}

function GitHubIcon() {
  return (
    <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
      <path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0024 12c0-6.63-5.37-12-12-12z"/>
    </svg>
  );
}
```

## 4. 浏览器插件认证流程

### 4.1 Options 页面登录

```tsx
// entrypoints/options/pages/Account.tsx
import React from 'react';
import { useAuth } from '@/hooks/useAuth';
import { useMembership } from '@/hooks/useMembership';
import { AuthForm } from '@/components/AuthForm';
import { t } from '@/utils/i18n';

export function AccountPage() {
  const { user, isAuthenticated, signOut, loading } = useAuth();
  const { membership, isPro, refresh } = useMembership();

  if (loading) {
    return <div className="loading">{t('common.loading')}</div>;
  }

  if (!isAuthenticated) {
    return (
      <div className="account-page">
        <h1>{t('settings.title')}</h1>
        <AuthForm />
      </div>
    );
  }

  return (
    <div className="account-page">
      <h1>{t('settings.title')}</h1>
      
      <div className="user-info">
        {user?.image && (
          <img src={user.image} alt={user.name || ''} className="avatar" />
        )}
        <div className="user-details">
          <h2>{user?.name || user?.email}</h2>
          <p>{user?.email}</p>
        </div>
      </div>

      <div className="membership-section">
        <h3>{t('settings.membershipStatus')}</h3>
        <div className={`membership-badge ${isPro ? 'pro' : 'free'}`}>
          {isPro ? t('settings.membershipPro') : t('settings.membershipFree')}
        </div>
        
        {isPro && membership?.expiresAt && (
          <p className="expires">
            {t('settings.membershipExpires')}: {new Date(membership.expiresAt).toLocaleDateString()}
          </p>
        )}

        {!isPro && (
          <a href={`${API_BASE_URL}/pricing`} className="upgrade-btn" target="_blank">
            {t('settings.upgradeToPro')}
          </a>
        )}
        
        <button onClick={refresh} className="refresh-btn">
          Refresh Status
        </button>
      </div>

      <button onClick={signOut} className="signout-btn">
        Sign Out
      </button>
    </div>
  );
}
```

### 4.2 后台脚本认证状态同步

```typescript
// entrypoints/background/auth.ts
import { storage } from 'wxt/storage';
import { authClient } from '@/lib/auth-client';

// 存储认证状态
export const authStorage = storage.defineItem<{
  user: { id: string; email: string; name: string | null } | null;
  token: string | null;
}>('local:auth', {
  fallback: { user: null, token: null },
});

// 检查并刷新认证状态
export async function checkAuthStatus() {
  try {
    const session = await authClient.getSession();
    if (session?.user) {
      await authStorage.setValue({
        user: session.user,
        token: session.session.token,
      });
      return session.user;
    } else {
      await authStorage.setValue({ user: null, token: null });
      return null;
    }
  } catch (error) {
    console.error('Auth check failed:', error);
    return null;
  }
}

// 监听来自 Options/Popup 的认证消息
browser.runtime.onMessage.addListener(async (message) => {
  if (message.action === 'authStateChanged') {
    await checkAuthStatus();
    return { success: true };
  }
  
  if (message.action === 'getAuthState') {
    return authStorage.getValue();
  }
});

// 定期检查认证状态
browser.alarms.create('auth-check', { periodInMinutes: 30 });
browser.alarms.onAlarm.addListener((alarm) => {
  if (alarm.name === 'auth-check') {
    checkAuthStatus();
  }
});
```

## 5. OAuth 回调页面

```typescript
// src/routes/landing.ts (部分)
import { Hono } from 'hono';
import { html } from 'hono/html';

export const landingRoutes = new Hono();

// OAuth 回调处理
landingRoutes.get('/auth/callback', async (c) => {
  // better-auth 会自动处理 OAuth 回调
  // 这个页面用于关闭弹窗并通知插件
  return c.html(html`
    <!DOCTYPE html>
    <html>
    <head>
      <title>Authentication Complete</title>
      <style>
        body {
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
          display: flex;
          align-items: center;
          justify-content: center;
          min-height: 100vh;
          margin: 0;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
        }
        .container {
          text-align: center;
          padding: 40px;
          background: rgba(255,255,255,0.1);
          border-radius: 16px;
          backdrop-filter: blur(10px);
        }
        .checkmark {
          font-size: 48px;
          margin-bottom: 20px;
        }
        h1 { margin: 0 0 10px; }
        p { opacity: 0.9; }
      </style>
    </head>
    <body>
      <div class="container">
        <div class="checkmark">&#10003;</div>
        <h1>Authentication Successful!</h1>
        <p>You can close this window now.</p>
      </div>
      <script>
        // 通知浏览器插件认证完成
        if (window.opener) {
          window.opener.postMessage({ type: 'AUTH_SUCCESS' }, '*');
          setTimeout(() => window.close(), 1500);
        } else {
          // 如果是从插件直接打开的
          setTimeout(() => {
            window.location.href = '/dashboard';
          }, 1500);
        }
      </script>
    </body>
    </html>
  `);
});
```

## 总结

本章节完成了:

1. **better-auth 完整配置** - OAuth、邮箱登录、会话管理
2. **邮件服务** - 验证邮件、密码重置邮件模板
3. **认证中间件** - requireAuth、optionalAuth、requirePro
4. **React 认证组件** - useAuth Hook、AuthForm 组件
5. **浏览器插件集成** - 认证状态同步、后台检查

下一章将介绍支付系统的实现,包括可扩展的支付架构和 Creem 集成。
