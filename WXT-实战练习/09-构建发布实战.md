# WXT 实战练习 09: 构建与发布

## 练习目标

通过本练习,你将:
- 掌握多浏览器构建流程
- 配置生产环境优化
- 了解商店发布流程
- 实现自动化发布

## 练习 9.1: 多浏览器构建

### 任务

为 Chrome 和 Firefox 分别构建扩展。

### 步骤

1. 配置 package.json 脚本:

```json
{
  "scripts": {
    "dev": "wxt",
    "dev:firefox": "wxt -b firefox",
    "dev:edge": "wxt -b edge",
    "build": "wxt build",
    "build:firefox": "wxt build -b firefox",
    "build:edge": "wxt build -b edge",
    "build:all": "pnpm build && pnpm build:firefox && pnpm build:edge",
    "zip": "wxt zip",
    "zip:firefox": "wxt zip -b firefox",
    "zip:all": "pnpm zip && pnpm zip:firefox",
    "postinstall": "wxt prepare"
  }
}
```

2. 执行构建:

```bash
# 构建所有浏览器版本
pnpm build:all

# 查看输出
ls -la .output/
```

3. 查看生成的 manifest 差异:

```bash
# Chrome MV3
cat .output/chrome-mv3/manifest.json

# Firefox MV2
cat .output/firefox-mv2/manifest.json
```

### 浏览器差异处理

```typescript
// wxt.config.ts
import { defineConfig } from 'wxt';

export default defineConfig({
  manifest: ({ browser, manifestVersion }) => ({
    name: 'My Extension',
    
    // 浏览器特定配置
    ...(browser === 'firefox' ? {
      browser_specific_settings: {
        gecko: {
          id: 'myextension@example.com',
          strict_min_version: '109.0',
        },
      },
    } : {}),

    // MV2/MV3 特定配置
    ...(manifestVersion === 2 ? {
      browser_action: {
        default_popup: 'popup.html',
      },
    } : {
      action: {
        default_popup: 'popup.html',
      },
    }),
  }),
});
```

### 验证

- [ ] 三个浏览器版本都构建成功
- [ ] manifest.json 针对不同浏览器正确配置

---

## 练习 9.2: 生产环境优化

### 任务

配置生产构建优化。

### 步骤

1. 配置 Vite 优化:

```typescript
// wxt.config.ts
import { defineConfig } from 'wxt';

export default defineConfig({
  vite: () => ({
    build: {
      // 生产环境移除 console
      minify: 'terser',
      terserOptions: {
        compress: {
          drop_console: true,
          drop_debugger: true,
        },
      },
      
      // 分块策略
      rollupOptions: {
        output: {
          manualChunks: {
            react: ['react', 'react-dom'],
          },
        },
      },
    },
    
    // 生产环境定义
    define: {
      __DEV__: JSON.stringify(process.env.NODE_ENV !== 'production'),
    },
  }),
});
```

2. 条件日志:

```typescript
// utils/logger.ts
export const logger = {
  log: (...args: any[]) => {
    if (__DEV__) {
      console.log('[Extension]', ...args);
    }
  },
  warn: (...args: any[]) => {
    if (__DEV__) {
      console.warn('[Extension]', ...args);
    }
  },
  error: (...args: any[]) => {
    // 错误始终记录
    console.error('[Extension]', ...args);
  },
};

declare const __DEV__: boolean;
```

3. 环境变量配置:

```env
# .env
WXT_APP_NAME=My Extension

# .env.production
WXT_API_URL=https://api.production.com
WXT_ANALYTICS_ID=UA-XXXXX

# .env.development
WXT_API_URL=http://localhost:3000
WXT_ANALYTICS_ID=
```

### 验证

```bash
# 开发构建
pnpm dev

# 生产构建
pnpm build

# 比较构建大小
du -sh .output/chrome-mv3/
```

---

## 练习 9.3: 版本管理

### 任务

实现版本号自动管理。

### 步骤

1. 创建版本更新脚本:

```typescript
// scripts/bump-version.ts
import fs from 'fs';
import path from 'path';

const packagePath = path.join(process.cwd(), 'package.json');
const pkg = JSON.parse(fs.readFileSync(packagePath, 'utf-8'));

const versionParts = pkg.version.split('.').map(Number);
const bumpType = process.argv[2] || 'patch';

switch (bumpType) {
  case 'major':
    versionParts[0]++;
    versionParts[1] = 0;
    versionParts[2] = 0;
    break;
  case 'minor':
    versionParts[1]++;
    versionParts[2] = 0;
    break;
  case 'patch':
  default:
    versionParts[2]++;
}

const newVersion = versionParts.join('.');
pkg.version = newVersion;

fs.writeFileSync(packagePath, JSON.stringify(pkg, null, 2) + '\n');

console.log(`Version bumped to ${newVersion}`);
```

2. 配置 manifest 使用 package.json 版本:

```typescript
// wxt.config.ts
import pkg from './package.json';

export default defineConfig({
  manifest: {
    version: pkg.version,
    version_name: `${pkg.version} (${process.env.GIT_COMMIT_SHORT || 'dev'})`,
  },
});
```

3. 添加脚本:

```json
{
  "scripts": {
    "version:patch": "tsx scripts/bump-version.ts patch",
    "version:minor": "tsx scripts/bump-version.ts minor",
    "version:major": "tsx scripts/bump-version.ts major",
    "release": "pnpm version:patch && pnpm build:all && pnpm zip:all"
  }
}
```

### 验证

```bash
# 更新补丁版本并构建
pnpm release
```

---

## 练习 9.4: 打包与分发

### 任务

创建可提交到商店的 zip 包。

### 步骤

1. 使用 WXT 内置命令:

```bash
# Chrome
pnpm wxt zip

# Firefox
pnpm wxt zip -b firefox

# 查看生成的 zip
ls -la .output/
```

2. 自定义打包逻辑:

```typescript
// wxt.config.ts
export default defineConfig({
  zip: {
    // 自定义文件名
    artifactTemplate: '{{name}}-{{version}}-{{browser}}.zip',
    
    // 排除文件
    excludeSources: ['**/*.map', '**/test/**'],
    
    // 包含源码 (Firefox 要求)
    includeSources: ['src/**', 'wxt.config.ts', 'package.json'],
  },
});
```

3. 创建发布清单:

```typescript
// scripts/prepare-release.ts
import fs from 'fs';
import path from 'path';

const outputDir = '.output';
const releaseDir = 'release';

// 创建发布目录
if (!fs.existsSync(releaseDir)) {
  fs.mkdirSync(releaseDir);
}

// 复制 zip 文件
const zipFiles = fs.readdirSync(outputDir).filter(f => f.endsWith('.zip'));
zipFiles.forEach(file => {
  fs.copyFileSync(
    path.join(outputDir, file),
    path.join(releaseDir, file)
  );
});

// 生成发布说明
const changelog = `# Release Notes

## Version ${require('../package.json').version}

### Changes
- [Add your changes here]

### Files
${zipFiles.map(f => `- ${f}`).join('\n')}

### Installation
1. Chrome: Upload to Chrome Web Store
2. Firefox: Upload to Firefox Add-ons

Generated at: ${new Date().toISOString()}
`;

fs.writeFileSync(path.join(releaseDir, 'RELEASE_NOTES.md'), changelog);

console.log('Release prepared in', releaseDir);
```

### 验证

- [ ] zip 文件正确生成
- [ ] 文件名包含版本和浏览器信息
- [ ] 发布目录包含所有需要的文件

---

## 练习 9.5: Chrome Web Store 发布

### 任务

了解并准备 Chrome Web Store 发布流程。

### 准备材料清单

```
chrome-store/
├── extension.zip          # 扩展包 (最大 500MB)
├── icon-128.png           # 商店图标 (128x128)
├── screenshot-1.png       # 截图 (1280x800 或 640x400)
├── screenshot-2.png
├── promo-small.png        # 小型宣传图 (440x280)
├── promo-large.png        # 大型宣传图 (1400x560, 可选)
├── description.txt        # 详细描述 (最多 16000 字符)
└── privacy-policy.md      # 隐私政策 (如使用敏感权限)
```

### 发布步骤

1. **注册开发者账号**
   - 访问 https://chrome.google.com/webstore/devconsole
   - 支付一次性 $5 注册费

2. **创建商品**
   - 点击 "New Item"
   - 上传 zip 包

3. **填写商店信息**
   ```
   - 名称: My Extension
   - 简短描述: (最多 132 字符)
   - 详细描述: (最多 16000 字符)
   - 分类: Productivity / Developer Tools / etc.
   - 语言: 中文 (简体)
   ```

4. **上传素材**
   - 至少 1 张截图
   - 128x128 图标
   - 可选: 宣传图片

5. **设置隐私权**
   - 声明使用的权限及原因
   - 提供隐私政策 URL (如需要)

6. **提交审核**
   - 首次审核可能需要 1-3 天
   - 更新审核通常更快

### 自动发布脚本

```typescript
// scripts/publish-chrome.ts
import { execSync } from 'child_process';

// 需要安装 chrome-webstore-upload-cli
// pnpm add -D chrome-webstore-upload-cli

const extensionId = process.env.CHROME_EXTENSION_ID;
const clientId = process.env.CHROME_CLIENT_ID;
const clientSecret = process.env.CHROME_CLIENT_SECRET;
const refreshToken = process.env.CHROME_REFRESH_TOKEN;

if (!extensionId || !clientId || !clientSecret || !refreshToken) {
  console.error('Missing environment variables');
  process.exit(1);
}

try {
  execSync(`chrome-webstore-upload upload \
    --source .output/my-extension-chrome.zip \
    --extension-id ${extensionId} \
    --client-id ${clientId} \
    --client-secret ${clientSecret} \
    --refresh-token ${refreshToken}`, 
    { stdio: 'inherit' }
  );

  // 可选: 自动发布
  // execSync(`chrome-webstore-upload publish ...`);
  
  console.log('Upload successful!');
} catch (error) {
  console.error('Upload failed:', error);
  process.exit(1);
}
```

---

## 练习 9.6: Firefox Add-ons 发布

### 任务

准备 Firefox Add-ons 发布。

### Firefox 特殊要求

1. **扩展 ID 必须声明**:

```typescript
// wxt.config.ts
export default defineConfig({
  manifest: ({ browser }) => ({
    ...(browser === 'firefox' ? {
      browser_specific_settings: {
        gecko: {
          id: 'my-extension@example.com',
          strict_min_version: '109.0',
        },
      },
    } : {}),
  }),
});
```

2. **源码提交**: Firefox 可能要求查看源码

```bash
# 打包源码
pnpm wxt zip:sources
```

### 准备材料

```
firefox-addons/
├── extension.zip          # 扩展包
├── source.zip             # 源码包 (如需要)
├── icon-128.png           # 图标
├── screenshot-1.png       # 截图 (最大 3MB)
└── description.md         # 描述
```

### 发布步骤

1. 访问 https://addons.mozilla.org/developers/
2. 提交新附加组件
3. 上传 zip 文件
4. 填写信息和分类
5. 提交审核

---

## 练习 9.7: CI/CD 自动发布

### 任务

配置 GitHub Actions 自动构建和发布。

### 步骤

```yaml
# .github/workflows/release.yml
name: Release Extension

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: pnpm/action-setup@v2
        with:
          version: 8
          
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          
      - run: pnpm install
      
      - run: pnpm build:all
      
      - run: pnpm zip:all
      
      - name: Upload Chrome Extension
        uses: actions/upload-artifact@v4
        with:
          name: chrome-extension
          path: .output/*-chrome-*.zip
          
      - name: Upload Firefox Extension
        uses: actions/upload-artifact@v4
        with:
          name: firefox-extension
          path: .output/*-firefox-*.zip
          
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            .output/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-chrome:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: chrome-extension
          
      - name: Upload to Chrome Web Store
        uses: mnao305/chrome-extension-upload@v4.0.1
        with:
          file-path: ./*.zip
          extension-id: ${{ secrets.CHROME_EXTENSION_ID }}
          client-id: ${{ secrets.CHROME_CLIENT_ID }}
          client-secret: ${{ secrets.CHROME_CLIENT_SECRET }}
          refresh-token: ${{ secrets.CHROME_REFRESH_TOKEN }}
```

### 发布流程

```bash
# 1. 更新版本
pnpm version:patch

# 2. 提交变更
git add .
git commit -m "chore: bump version to x.x.x"

# 3. 创建标签
git tag v1.0.1

# 4. 推送触发 CI
git push && git push --tags
```

### 验证

- [ ] 推送标签后 GitHub Actions 自动运行
- [ ] 构建产物正确上传
- [ ] Release 页面包含 zip 文件

---

## 自我检查

1. 如何为不同浏览器构建扩展?
2. Firefox 扩展必须声明什么?
3. Chrome Web Store 提交需要哪些材料?
4. 如何在生产构建中移除 console?
5. WXT 的 zip 命令做什么?

## 参考答案

1. 使用 `-b` 参数: `wxt build -b firefox`
2. browser_specific_settings.gecko.id (扩展 ID)
3. zip 包、截图、图标、描述、隐私政策 (如需要)
4. 配置 Vite terser 的 drop_console 选项
5. 创建可上传到商店的 zip 包
