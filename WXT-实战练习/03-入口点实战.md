# WXT 实战练习 03: 入口点系统深入

## 练习目标

通过本练习,你将:
- 掌握各种入口点类型的创建
- 理解入口点配置选项
- 学会使用 HTML 和脚本入口点

## 练习 3.1: 创建完整的 Popup

### 任务

创建一个功能完整的 Popup 页面。

### 步骤

1. 创建 Popup 入口:

```
entrypoints/
└── popup/
    ├── index.html
    ├── main.tsx
    ├── App.tsx
    └── App.css
```

2. 编写 HTML 入口:

```html
<!-- entrypoints/popup/index.html -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=400, height=600">
  <title>My Extension Popup</title>
</head>
<body>
  <div id="root"></div>
  <script type="module" src="./main.tsx"></script>
</body>
</html>
```

3. 编写入口脚本:

```tsx
// entrypoints/popup/main.tsx
import React from 'react';
import ReactDOM from 'react-dom/client';
import App from './App';
import './App.css';

ReactDOM.createRoot(document.getElementById('root')!).render(
  <React.StrictMode>
    <App />
  </React.StrictMode>
);
```

4. 编写 App 组件:

```tsx
// entrypoints/popup/App.tsx
import { useState, useEffect } from 'react';

function App() {
  const [currentUrl, setCurrentUrl] = useState<string>('');
  const [tabCount, setTabCount] = useState<number>(0);

  useEffect(() => {
    // 获取当前标签页信息
    browser.tabs.query({ active: true, currentWindow: true })
      .then(tabs => {
        if (tabs[0]?.url) {
          setCurrentUrl(tabs[0].url);
        }
      });

    // 获取标签页数量
    browser.tabs.query({})
      .then(tabs => {
        setTabCount(tabs.length);
      });
  }, []);

  return (
    <div className="popup-container">
      <h1>我的扩展</h1>
      <div className="info-card">
        <h3>当前页面</h3>
        <p className="url">{currentUrl || '加载中...'}</p>
      </div>
      <div className="info-card">
        <h3>打开的标签页</h3>
        <p className="count">{tabCount} 个</p>
      </div>
    </div>
  );
}

export default App;
```

5. 添加样式:

```css
/* entrypoints/popup/App.css */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  width: 350px;
  min-height: 200px;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

.popup-container {
  padding: 16px;
}

h1 {
  font-size: 20px;
  margin-bottom: 16px;
  color: #333;
}

.info-card {
  background: #f5f5f5;
  border-radius: 8px;
  padding: 12px;
  margin-bottom: 12px;
}

.info-card h3 {
  font-size: 14px;
  color: #666;
  margin-bottom: 8px;
}

.url {
  font-size: 12px;
  color: #333;
  word-break: break-all;
}

.count {
  font-size: 24px;
  font-weight: bold;
  color: #2196f3;
}
```

### 验证

- [ ] 点击扩展图标打开 Popup
- [ ] 显示当前页面 URL
- [ ] 显示标签页数量

---

## 练习 3.2: 创建 Options 页面

### 任务

创建一个在新标签页打开的选项页面。

### 步骤

1. 创建目录结构:

```
entrypoints/
└── options/
    ├── index.html
    ├── main.tsx
    └── App.tsx
```

2. 配置为新标签页打开:

```html
<!-- entrypoints/options/index.html -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- 在新标签页打开 -->
  <meta name="manifest.open_in_tab" content="true">
  <title>扩展设置</title>
</head>
<body>
  <div id="root"></div>
  <script type="module" src="./main.tsx"></script>
</body>
</html>
```

3. 实现设置页面:

```tsx
// entrypoints/options/App.tsx
import { useState, useEffect } from 'react';

interface Settings {
  theme: 'light' | 'dark';
  autoSave: boolean;
  maxItems: number;
}

const defaultSettings: Settings = {
  theme: 'light',
  autoSave: true,
  maxItems: 100,
};

function App() {
  const [settings, setSettings] = useState<Settings>(defaultSettings);
  const [saved, setSaved] = useState(false);

  useEffect(() => {
    // 加载设置
    browser.storage.sync.get('settings').then(result => {
      if (result.settings) {
        setSettings(result.settings);
      }
    });
  }, []);

  const handleSave = async () => {
    await browser.storage.sync.set({ settings });
    setSaved(true);
    setTimeout(() => setSaved(false), 2000);
  };

  return (
    <div style={{ maxWidth: 600, margin: '40px auto', padding: 20 }}>
      <h1>扩展设置</h1>
      
      <div style={{ marginTop: 24 }}>
        <label style={{ display: 'block', marginBottom: 16 }}>
          <span>主题</span>
          <select
            value={settings.theme}
            onChange={e => setSettings({
              ...settings,
              theme: e.target.value as 'light' | 'dark'
            })}
            style={{ marginLeft: 12, padding: 8 }}
          >
            <option value="light">浅色</option>
            <option value="dark">深色</option>
          </select>
        </label>

        <label style={{ display: 'block', marginBottom: 16 }}>
          <input
            type="checkbox"
            checked={settings.autoSave}
            onChange={e => setSettings({
              ...settings,
              autoSave: e.target.checked
            })}
          />
          <span style={{ marginLeft: 8 }}>自动保存</span>
        </label>

        <label style={{ display: 'block', marginBottom: 16 }}>
          <span>最大条目数</span>
          <input
            type="number"
            value={settings.maxItems}
            onChange={e => setSettings({
              ...settings,
              maxItems: parseInt(e.target.value) || 0
            })}
            style={{ marginLeft: 12, padding: 8, width: 100 }}
          />
        </label>
      </div>

      <button
        onClick={handleSave}
        style={{
          padding: '12px 24px',
          background: '#2196f3',
          color: 'white',
          border: 'none',
          borderRadius: 4,
          cursor: 'pointer',
        }}
      >
        保存设置
      </button>

      {saved && (
        <span style={{ marginLeft: 12, color: 'green' }}>
          已保存!
        </span>
      )}
    </div>
  );
}

export default App;
```

### 验证

- [ ] 右键扩展图标 -> 选项 (或在 chrome://extensions 点击"详情" -> "扩展选项")
- [ ] 选项页面在新标签页打开
- [ ] 设置可以保存和加载

---

## 练习 3.3: Side Panel (侧边栏)

### 任务

创建 Chrome 侧边栏页面。

### 步骤

1. 创建侧边栏入口:

```
entrypoints/
└── sidepanel/
    ├── index.html
    ├── main.tsx
    └── App.tsx
```

2. 配置侧边栏:

```html
<!-- entrypoints/sidepanel/index.html -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>侧边栏</title>
</head>
<body>
  <div id="root"></div>
  <script type="module" src="./main.tsx"></script>
</body>
</html>
```

3. 在 wxt.config.ts 中添加权限:

```typescript
// wxt.config.ts
export default defineConfig({
  manifest: {
    permissions: ['sidePanel'],
    side_panel: {
      default_path: 'sidepanel/index.html',
    },
  },
});
```

4. 实现侧边栏:

```tsx
// entrypoints/sidepanel/App.tsx
import { useState, useEffect } from 'react';

interface Bookmark {
  id: string;
  title: string;
  url: string;
  timestamp: number;
}

function App() {
  const [bookmarks, setBookmarks] = useState<Bookmark[]>([]);

  useEffect(() => {
    loadBookmarks();
  }, []);

  const loadBookmarks = async () => {
    const result = await browser.storage.local.get('bookmarks');
    setBookmarks(result.bookmarks || []);
  };

  const addCurrentPage = async () => {
    const [tab] = await browser.tabs.query({ 
      active: true, 
      currentWindow: true 
    });
    
    if (tab.url && tab.title) {
      const newBookmark: Bookmark = {
        id: Date.now().toString(),
        title: tab.title,
        url: tab.url,
        timestamp: Date.now(),
      };
      
      const updated = [newBookmark, ...bookmarks];
      await browser.storage.local.set({ bookmarks: updated });
      setBookmarks(updated);
    }
  };

  const removeBookmark = async (id: string) => {
    const updated = bookmarks.filter(b => b.id !== id);
    await browser.storage.local.set({ bookmarks: updated });
    setBookmarks(updated);
  };

  return (
    <div style={{ padding: 16 }}>
      <h2>书签收藏</h2>
      
      <button 
        onClick={addCurrentPage}
        style={{
          width: '100%',
          padding: 12,
          marginBottom: 16,
          background: '#4caf50',
          color: 'white',
          border: 'none',
          borderRadius: 4,
          cursor: 'pointer',
        }}
      >
        收藏当前页面
      </button>

      <div>
        {bookmarks.map(bookmark => (
          <div 
            key={bookmark.id}
            style={{
              padding: 12,
              marginBottom: 8,
              background: '#f5f5f5',
              borderRadius: 4,
            }}
          >
            <a 
              href={bookmark.url}
              target="_blank"
              style={{ 
                display: 'block',
                color: '#1976d2',
                textDecoration: 'none',
                marginBottom: 4,
              }}
            >
              {bookmark.title}
            </a>
            <div style={{ 
              display: 'flex', 
              justifyContent: 'space-between',
              fontSize: 12,
              color: '#666',
            }}>
              <span>
                {new Date(bookmark.timestamp).toLocaleString()}
              </span>
              <button
                onClick={() => removeBookmark(bookmark.id)}
                style={{
                  background: 'none',
                  border: 'none',
                  color: '#f44336',
                  cursor: 'pointer',
                }}
              >
                删除
              </button>
            </div>
          </div>
        ))}
      </div>
    </div>
  );
}

export default App;
```

### 验证

- [ ] 点击工具栏的侧边栏图标
- [ ] 侧边栏正确显示
- [ ] 可以添加和删除书签

---

## 练习 3.4: Unlisted Scripts

### 任务

创建不在 manifest 中声明的脚本,用于动态注入。

### 步骤

1. 创建 unlisted 脚本:

```typescript
// entrypoints/injected.ts
export default defineUnlistedScript(() => {
  console.log('Injected script running in page context');
  
  // 在页面上下文中执行,可以访问页面变量
  (window as any).__EXTENSION_INJECTED__ = true;
  
  // 拦截 fetch 请求
  const originalFetch = window.fetch;
  window.fetch = async (...args) => {
    console.log('[Extension] Fetch intercepted:', args[0]);
    return originalFetch.apply(window, args);
  };
});
```

2. 配置 web_accessible_resources:

```typescript
// wxt.config.ts
export default defineConfig({
  manifest: {
    web_accessible_resources: [
      {
        resources: ['injected.js'],
        matches: ['<all_urls>'],
      },
    ],
  },
});
```

3. 从内容脚本注入:

```typescript
// entrypoints/content.ts
export default defineContentScript({
  matches: ['*://*.example.com/*'],
  
  main() {
    // 注入脚本到页面主世界
    const script = document.createElement('script');
    script.src = browser.runtime.getURL('/injected.js');
    script.onload = () => script.remove();
    (document.head || document.documentElement).appendChild(script);
    
    console.log('Script injected');
  },
});
```

### 验证

- [ ] 访问 example.com
- [ ] 控制台显示注入日志
- [ ] 页面的 fetch 被拦截

---

## 练习 3.5: 多入口点组合

### 任务

创建一个完整的扩展,包含所有主要入口点类型。

### 步骤

创建以下结构:

```
entrypoints/
├── background.ts
├── content.ts
├── popup/
│   ├── index.html
│   ├── main.tsx
│   └── App.tsx
├── options/
│   ├── index.html
│   ├── main.tsx
│   └── App.tsx
├── sidepanel/
│   ├── index.html
│   ├── main.tsx
│   └── App.tsx
├── newtab/
│   ├── index.html
│   ├── main.tsx
│   └── App.tsx
└── injected.ts
```

实现各入口点之间的通信:

```typescript
// entrypoints/background.ts
export default defineBackground(() => {
  // 监听来自所有入口点的消息
  browser.runtime.onMessage.addListener((message, sender) => {
    console.log('Message from:', sender.url || sender.tab?.url);
    console.log('Content:', message);
    
    if (message.type === 'GET_STATE') {
      return Promise.resolve({ count: 42 });
    }
  });
});
```

```tsx
// 在任意 React 入口点中使用
function useBackgroundState() {
  const [state, setState] = useState<{ count: number } | null>(null);

  useEffect(() => {
    browser.runtime.sendMessage({ type: 'GET_STATE' })
      .then(setState);
  }, []);

  return state;
}
```

### 验证

- [ ] 所有入口点正常加载
- [ ] 入口点之间可以通信
- [ ] 查看 manifest.json 确认所有入口点都已注册

---

## 挑战练习

### 挑战: 创建自定义新标签页

替换浏览器默认的新标签页:

```html
<!-- entrypoints/newtab/index.html -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>新标签页</title>
  <style>
    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-family: system-ui, sans-serif;
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="module" src="./main.tsx"></script>
</body>
</html>
```

```tsx
// entrypoints/newtab/App.tsx
import { useState, useEffect } from 'react';

function App() {
  const [time, setTime] = useState(new Date());
  const [greeting, setGreeting] = useState('');

  useEffect(() => {
    const timer = setInterval(() => setTime(new Date()), 1000);
    return () => clearInterval(timer);
  }, []);

  useEffect(() => {
    const hour = time.getHours();
    if (hour < 12) setGreeting('早上好');
    else if (hour < 18) setGreeting('下午好');
    else setGreeting('晚上好');
  }, [time]);

  return (
    <div style={{ textAlign: 'center' }}>
      <h1 style={{ fontSize: 72, marginBottom: 16 }}>
        {time.toLocaleTimeString('zh-CN', { 
          hour: '2-digit', 
          minute: '2-digit' 
        })}
      </h1>
      <p style={{ fontSize: 24, opacity: 0.8 }}>{greeting}</p>
      <p style={{ marginTop: 48, opacity: 0.6 }}>
        {time.toLocaleDateString('zh-CN', {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric',
        })}
      </p>
    </div>
  );
}

export default App;
```

---

## 自我检查

1. 如何让 options 页面在新标签页打开?
2. unlisted script 和普通 content script 的区别?
3. sidepanel 需要什么权限?
4. 如何创建多个同类型的入口点?
5. 入口点文件的命名规则是什么?

## 参考答案

1. 在 HTML 中添加 `<meta name="manifest.open_in_tab" content="true">`
2. unlisted script 不在 manifest 中声明,需要手动注入,运行在页面主世界
3. `sidePanel` 权限
4. 使用命名约定: `name.content.ts` 或 `content.name.ts`
5. 类型关键字可以在文件名开头或结尾: `background.ts`, `content.ts`, `popup/index.html`
