# WXT 实战练习 04: 后台脚本开发

## 练习目标

通过本练习,你将:
- 掌握 Service Worker 生命周期
- 实现各种后台任务
- 处理扩展事件监听
- 使用 Alarms API 定时任务

## 练习 4.1: 基础后台脚本

### 任务

创建一个后台脚本,监听扩展安装和更新事件。

### 步骤

```typescript
// entrypoints/background.ts
export default defineBackground(() => {
  console.log('Background script started', { id: browser.runtime.id });

  // 监听安装事件
  browser.runtime.onInstalled.addListener((details) => {
    console.log('Extension installed/updated:', details.reason);
    
    if (details.reason === 'install') {
      // 首次安装
      browser.storage.local.set({
        installTime: Date.now(),
        version: browser.runtime.getManifest().version,
      });
      
      // 打开欢迎页面
      browser.tabs.create({
        url: browser.runtime.getURL('/options.html'),
      });
    }
    
    if (details.reason === 'update') {
      // 版本更新
      const previousVersion = details.previousVersion;
      const currentVersion = browser.runtime.getManifest().version;
      console.log(`Updated from ${previousVersion} to ${currentVersion}`);
    }
  });

  // 监听启动事件
  browser.runtime.onStartup.addListener(() => {
    console.log('Browser started, extension activated');
  });
});
```

### 验证

- [ ] 重新加载扩展,查看控制台日志
- [ ] 确认 storage 中保存了安装时间

---

## 练习 4.2: 右键菜单

### 任务

创建自定义右键菜单。

### 步骤

1. 添加权限:

```typescript
// wxt.config.ts
export default defineConfig({
  manifest: {
    permissions: ['contextMenus', 'storage'],
  },
});
```

2. 实现右键菜单:

```typescript
// entrypoints/background.ts
export default defineBackground(() => {
  // 创建右键菜单
  browser.runtime.onInstalled.addListener(() => {
    // 父菜单
    browser.contextMenus.create({
      id: 'parent-menu',
      title: '我的扩展',
      contexts: ['all'],
    });

    // 子菜单 - 选中文本时
    browser.contextMenus.create({
      id: 'search-text',
      parentId: 'parent-menu',
      title: '搜索 "%s"',
      contexts: ['selection'],
    });

    // 子菜单 - 链接上
    browser.contextMenus.create({
      id: 'save-link',
      parentId: 'parent-menu',
      title: '保存链接',
      contexts: ['link'],
    });

    // 子菜单 - 图片上
    browser.contextMenus.create({
      id: 'save-image',
      parentId: 'parent-menu',
      title: '保存图片链接',
      contexts: ['image'],
    });

    // 分隔线
    browser.contextMenus.create({
      id: 'separator',
      parentId: 'parent-menu',
      type: 'separator',
      contexts: ['all'],
    });

    // 打开设置
    browser.contextMenus.create({
      id: 'open-options',
      parentId: 'parent-menu',
      title: '扩展设置',
      contexts: ['all'],
    });
  });

  // 处理点击事件
  browser.contextMenus.onClicked.addListener(async (info, tab) => {
    switch (info.menuItemId) {
      case 'search-text':
        if (info.selectionText) {
          const searchUrl = `https://www.google.com/search?q=${encodeURIComponent(info.selectionText)}`;
          browser.tabs.create({ url: searchUrl });
        }
        break;

      case 'save-link':
        if (info.linkUrl) {
          const links = await browser.storage.local.get('savedLinks');
          const savedLinks = links.savedLinks || [];
          savedLinks.push({
            url: info.linkUrl,
            title: info.linkUrl,
            savedAt: Date.now(),
          });
          await browser.storage.local.set({ savedLinks });
          console.log('Link saved:', info.linkUrl);
        }
        break;

      case 'save-image':
        if (info.srcUrl) {
          const images = await browser.storage.local.get('savedImages');
          const savedImages = images.savedImages || [];
          savedImages.push({
            url: info.srcUrl,
            pageUrl: info.pageUrl,
            savedAt: Date.now(),
          });
          await browser.storage.local.set({ savedImages });
          console.log('Image saved:', info.srcUrl);
        }
        break;

      case 'open-options':
        browser.runtime.openOptionsPage();
        break;
    }
  });
});
```

### 验证

- [ ] 在页面上右键看到自定义菜单
- [ ] 选中文本后右键显示"搜索"选项
- [ ] 点击菜单项功能正常

---

## 练习 4.3: 快捷键命令

### 任务

实现键盘快捷键功能。

### 步骤

1. 配置快捷键:

```typescript
// wxt.config.ts
export default defineConfig({
  manifest: {
    commands: {
      'toggle-feature': {
        suggested_key: {
          default: 'Ctrl+Shift+Y',
          mac: 'Command+Shift+Y',
        },
        description: '切换功能开关',
      },
      'quick-save': {
        suggested_key: {
          default: 'Ctrl+Shift+S',
          mac: 'Command+Shift+S',
        },
        description: '快速保存当前页面',
      },
      '_execute_action': {
        suggested_key: {
          default: 'Ctrl+Shift+E',
          mac: 'Command+Shift+E',
        },
        description: '打开扩展弹窗',
      },
    },
  },
});
```

2. 处理快捷键:

```typescript
// entrypoints/background.ts
export default defineBackground(() => {
  // 监听快捷键
  browser.commands.onCommand.addListener(async (command) => {
    console.log('Command received:', command);

    switch (command) {
      case 'toggle-feature': {
        // 切换功能状态
        const result = await browser.storage.local.get('featureEnabled');
        const newState = !result.featureEnabled;
        await browser.storage.local.set({ featureEnabled: newState });
        
        // 更新图标徽章
        await browser.action.setBadgeText({
          text: newState ? 'ON' : 'OFF',
        });
        await browser.action.setBadgeBackgroundColor({
          color: newState ? '#4caf50' : '#f44336',
        });
        
        console.log('Feature toggled:', newState);
        break;
      }

      case 'quick-save': {
        // 获取当前标签页
        const [tab] = await browser.tabs.query({
          active: true,
          currentWindow: true,
        });
        
        if (tab?.url && tab?.title) {
          const saved = await browser.storage.local.get('quickSaves');
          const quickSaves = saved.quickSaves || [];
          quickSaves.unshift({
            id: Date.now().toString(),
            url: tab.url,
            title: tab.title,
            savedAt: Date.now(),
          });
          
          // 最多保存 50 条
          if (quickSaves.length > 50) {
            quickSaves.pop();
          }
          
          await browser.storage.local.set({ quickSaves });
          
          // 显示通知
          await browser.notifications.create({
            type: 'basic',
            iconUrl: browser.runtime.getURL('/icon/128.png'),
            title: '页面已保存',
            message: tab.title,
          });
        }
        break;
      }
    }
  });
});
```

### 验证

- [ ] 按 Ctrl+Shift+Y 切换功能状态
- [ ] 图标徽章显示 ON/OFF
- [ ] 按 Ctrl+Shift+S 保存页面并显示通知

---

## 练习 4.4: 定时任务 (Alarms)

### 任务

使用 Alarms API 实现定时任务。

### 步骤

1. 添加权限:

```typescript
// wxt.config.ts
export default defineConfig({
  manifest: {
    permissions: ['alarms', 'notifications'],
  },
});
```

2. 实现定时任务:

```typescript
// entrypoints/background.ts
export default defineBackground(() => {
  // 创建定时器
  browser.runtime.onInstalled.addListener(() => {
    // 每 30 分钟执行一次
    browser.alarms.create('periodic-check', {
      periodInMinutes: 30,
    });

    // 5 分钟后执行一次
    browser.alarms.create('delayed-task', {
      delayInMinutes: 5,
    });

    // 每天特定时间执行 (通过计算延迟)
    const now = new Date();
    const target = new Date();
    target.setHours(9, 0, 0, 0); // 每天 9:00
    
    if (target <= now) {
      target.setDate(target.getDate() + 1);
    }
    
    const delayInMinutes = (target.getTime() - now.getTime()) / 60000;
    browser.alarms.create('daily-reminder', {
      delayInMinutes,
      periodInMinutes: 24 * 60, // 每 24 小时
    });
  });

  // 处理定时器触发
  browser.alarms.onAlarm.addListener(async (alarm) => {
    console.log('Alarm triggered:', alarm.name, new Date().toISOString());

    switch (alarm.name) {
      case 'periodic-check':
        // 执行周期性检查
        await performPeriodicCheck();
        break;

      case 'delayed-task':
        // 执行延迟任务
        console.log('Delayed task executed');
        break;

      case 'daily-reminder':
        // 发送每日提醒
        browser.notifications.create({
          type: 'basic',
          iconUrl: browser.runtime.getURL('/icon/128.png'),
          title: '每日提醒',
          message: '新的一天开始了!',
        });
        break;
    }
  });

  async function performPeriodicCheck() {
    // 检查存储的数据
    const data = await browser.storage.local.get(null);
    console.log('Periodic check - Storage size:', 
      JSON.stringify(data).length, 'bytes');
    
    // 清理过期数据
    const now = Date.now();
    const oneWeekAgo = now - 7 * 24 * 60 * 60 * 1000;
    
    if (data.quickSaves) {
      const filtered = data.quickSaves.filter(
        (item: any) => item.savedAt > oneWeekAgo
      );
      if (filtered.length !== data.quickSaves.length) {
        await browser.storage.local.set({ quickSaves: filtered });
        console.log('Cleaned up old quick saves');
      }
    }
  }
});
```

3. 管理定时器:

```typescript
// utils/alarms.ts
export async function listAlarms() {
  const alarms = await browser.alarms.getAll();
  return alarms.map(alarm => ({
    name: alarm.name,
    scheduledTime: new Date(alarm.scheduledTime),
    periodInMinutes: alarm.periodInMinutes,
  }));
}

export async function cancelAlarm(name: string) {
  return browser.alarms.clear(name);
}

export async function cancelAllAlarms() {
  return browser.alarms.clearAll();
}
```

### 验证

- [ ] 查看后台控制台,确认定时器创建
- [ ] 等待定时器触发 (可以临时设置更短的间隔测试)

---

## 练习 4.5: 标签页管理

### 任务

实现标签页监控和管理功能。

### 步骤

```typescript
// entrypoints/background.ts
export default defineBackground(() => {
  // 存储标签页统计
  const tabStats = {
    created: 0,
    closed: 0,
    updated: 0,
  };

  // 监听标签页创建
  browser.tabs.onCreated.addListener((tab) => {
    tabStats.created++;
    console.log('Tab created:', tab.id, tab.pendingUrl || tab.url);
  });

  // 监听标签页关闭
  browser.tabs.onRemoved.addListener((tabId, removeInfo) => {
    tabStats.closed++;
    console.log('Tab closed:', tabId, 
      removeInfo.isWindowClosing ? '(window closing)' : '');
  });

  // 监听标签页更新
  browser.tabs.onUpdated.addListener((tabId, changeInfo, tab) => {
    if (changeInfo.status === 'complete') {
      tabStats.updated++;
      console.log('Tab loaded:', tab.url);
      
      // 可以在这里执行特定 URL 的操作
      if (tab.url?.includes('github.com')) {
        console.log('GitHub page detected');
      }
    }
  });

  // 监听标签页激活
  browser.tabs.onActivated.addListener(async (activeInfo) => {
    const tab = await browser.tabs.get(activeInfo.tabId);
    console.log('Tab activated:', tab.title);
    
    // 更新徽章显示当前域名
    try {
      const url = new URL(tab.url || '');
      browser.action.setBadgeText({
        text: url.hostname.slice(0, 3).toUpperCase(),
        tabId: activeInfo.tabId,
      });
    } catch {
      browser.action.setBadgeText({
        text: '',
        tabId: activeInfo.tabId,
      });
    }
  });

  // 提供统计信息的消息接口
  browser.runtime.onMessage.addListener((message) => {
    if (message.type === 'GET_TAB_STATS') {
      return Promise.resolve(tabStats);
    }
  });

  // 实用函数: 查找标签页
  async function findTabsByUrl(pattern: string) {
    const tabs = await browser.tabs.query({});
    return tabs.filter(tab => tab.url?.includes(pattern));
  }

  // 实用函数: 关闭重复标签页
  async function closeDuplicateTabs() {
    const tabs = await browser.tabs.query({});
    const seen = new Map<string, number>();
    const duplicates: number[] = [];

    for (const tab of tabs) {
      if (tab.url && tab.id) {
        if (seen.has(tab.url)) {
          duplicates.push(tab.id);
        } else {
          seen.set(tab.url, tab.id);
        }
      }
    }

    if (duplicates.length > 0) {
      await browser.tabs.remove(duplicates);
      console.log('Closed', duplicates.length, 'duplicate tabs');
    }

    return duplicates.length;
  }

  // 将函数暴露给消息接口
  browser.runtime.onMessage.addListener((message) => {
    if (message.type === 'CLOSE_DUPLICATES') {
      return closeDuplicateTabs();
    }
    if (message.type === 'FIND_TABS') {
      return findTabsByUrl(message.pattern);
    }
  });
});
```

### 验证

- [ ] 打开/关闭标签页,查看控制台日志
- [ ] 图标徽章显示当前网站缩写
- [ ] 从 Popup 获取标签页统计

---

## 练习 4.6: 网络请求监控

### 任务

监控和修改网络请求。

### 步骤

1. 添加权限:

```typescript
// wxt.config.ts
export default defineConfig({
  manifest: {
    permissions: ['webRequest'],
    host_permissions: ['<all_urls>'],
  },
});
```

2. 实现请求监控:

```typescript
// entrypoints/background.ts
export default defineBackground(() => {
  // 请求统计
  const requestStats = new Map<string, number>();

  // 监听请求开始
  browser.webRequest.onBeforeRequest.addListener(
    (details) => {
      // 统计请求类型
      const type = details.type;
      requestStats.set(type, (requestStats.get(type) || 0) + 1);

      // 记录大请求
      if (details.requestBody?.raw) {
        const size = details.requestBody.raw.reduce(
          (sum, part) => sum + (part.bytes?.byteLength || 0),
          0
        );
        if (size > 1024 * 1024) {
          console.log('Large request detected:', details.url, size, 'bytes');
        }
      }
    },
    { urls: ['<all_urls>'] },
    ['requestBody']
  );

  // 监听请求完成
  browser.webRequest.onCompleted.addListener(
    (details) => {
      // 记录慢请求
      const duration = Date.now() - details.timeStamp;
      if (duration > 5000) {
        console.log('Slow request:', details.url, duration, 'ms');
      }
    },
    { urls: ['<all_urls>'] }
  );

  // 监听请求错误
  browser.webRequest.onErrorOccurred.addListener(
    (details) => {
      console.error('Request failed:', details.url, details.error);
    },
    { urls: ['<all_urls>'] }
  );

  // 提供统计接口
  browser.runtime.onMessage.addListener((message) => {
    if (message.type === 'GET_REQUEST_STATS') {
      return Promise.resolve(Object.fromEntries(requestStats));
    }
    if (message.type === 'CLEAR_REQUEST_STATS') {
      requestStats.clear();
      return Promise.resolve(true);
    }
  });
});
```

### 验证

- [ ] 浏览网页时查看后台日志
- [ ] 从 Popup 获取请求统计

---

## 挑战练习

### 挑战: 实现自动休眠功能

当标签页超过指定时间未激活时,自动丢弃 (休眠) 它:

```typescript
// entrypoints/background.ts
export default defineBackground(() => {
  const tabLastActive = new Map<number, number>();
  const IDLE_THRESHOLD = 30 * 60 * 1000; // 30 分钟

  // 记录标签页激活时间
  browser.tabs.onActivated.addListener(({ tabId }) => {
    tabLastActive.set(tabId, Date.now());
  });

  // 清理已关闭标签页的记录
  browser.tabs.onRemoved.addListener((tabId) => {
    tabLastActive.delete(tabId);
  });

  // 定期检查并休眠空闲标签页
  browser.alarms.create('check-idle-tabs', { periodInMinutes: 5 });

  browser.alarms.onAlarm.addListener(async (alarm) => {
    if (alarm.name !== 'check-idle-tabs') return;

    const now = Date.now();
    const tabs = await browser.tabs.query({});
    const [activeTab] = await browser.tabs.query({ 
      active: true, 
      currentWindow: true 
    });

    for (const tab of tabs) {
      if (!tab.id || tab.id === activeTab?.id) continue;
      if (tab.pinned || tab.audible) continue; // 跳过固定和播放音频的标签页

      const lastActive = tabLastActive.get(tab.id) || 0;
      if (now - lastActive > IDLE_THRESHOLD) {
        try {
          await browser.tabs.discard(tab.id);
          console.log('Discarded idle tab:', tab.title);
        } catch (e) {
          console.error('Failed to discard tab:', e);
        }
      }
    }
  });
});
```

---

## 自我检查

1. MV3 中后台脚本是什么类型?
2. 如何创建周期性定时任务?
3. 右键菜单需要什么权限?
4. 如何监听扩展首次安装?
5. Service Worker 会在什么情况下终止?

## 参考答案

1. Service Worker (非持久性)
2. `browser.alarms.create(name, { periodInMinutes: N })`
3. `contextMenus` 权限
4. `browser.runtime.onInstalled.addListener`,检查 `details.reason === 'install'`
5. 空闲 30 秒后会被终止,有事件时重新激活
