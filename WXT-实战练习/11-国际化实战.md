# WXT 实战练习 11: 国际化 (i18n)

## 练习目标

通过本练习,你将:
- 掌握 WXT 国际化配置
- 使用 @wxt-dev/i18n 模块
- 实现多语言切换
- 处理 manifest 国际化

## 练习 11.1: 基础 i18n 配置

### 任务

配置扩展的多语言支持。

### 步骤

1. 安装 i18n 模块:

```bash
pnpm add @wxt-dev/i18n
```

2. 配置 wxt.config.ts:

```typescript
// wxt.config.ts
import { defineConfig } from 'wxt';

export default defineConfig({
  modules: ['@wxt-dev/i18n'],
  manifest: {
    default_locale: 'zh_CN',
  },
});
```

3. 创建语言文件:

```yaml
# src/locales/zh_CN.yml
extName: 我的扩展
extDescription: 一个强大的浏览器扩展

common:
  save: 保存
  cancel: 取消
  confirm: 确认
  delete: 删除
  edit: 编辑
  loading: 加载中...

popup:
  title: 控制面板
  welcome: 欢迎使用
  settings: 设置
  help: 帮助

settings:
  theme: 主题
  themeLight: 浅色
  themeDark: 深色
  themeSystem: 跟随系统
  language: 语言
  notifications: 通知
  enableNotifications: 启用通知

messages:
  saveSuccess: 保存成功
  saveError: 保存失败
  confirmDelete: 确定要删除吗?
```

```yaml
# src/locales/en.yml
extName: My Extension
extDescription: A powerful browser extension

common:
  save: Save
  cancel: Cancel
  confirm: Confirm
  delete: Delete
  edit: Edit
  loading: Loading...

popup:
  title: Control Panel
  welcome: Welcome
  settings: Settings
  help: Help

settings:
  theme: Theme
  themeLight: Light
  themeDark: Dark
  themeSystem: System
  language: Language
  notifications: Notifications
  enableNotifications: Enable notifications

messages:
  saveSuccess: Saved successfully
  saveError: Failed to save
  confirmDelete: Are you sure you want to delete?
```

```yaml
# src/locales/ja.yml
extName: 私の拡張機能
extDescription: 強力なブラウザ拡張機能

common:
  save: 保存
  cancel: キャンセル
  confirm: 確認
  delete: 削除
  edit: 編集
  loading: 読み込み中...

popup:
  title: コントロールパネル
  welcome: ようこそ
  settings: 設定
  help: ヘルプ
```

### 验证

- [ ] 语言文件创建成功
- [ ] 构建无错误

---

## 练习 11.2: 使用 i18n

### 任务

在代码中使用国际化文本。

### 步骤

```tsx
// entrypoints/popup/App.tsx
import { i18n } from '#i18n';

function App() {
  return (
    <div style={{ padding: 20, minWidth: 300 }}>
      <h1>{i18n.t('popup.title')}</h1>
      <p>{i18n.t('popup.welcome')}</p>
      
      <div style={{ marginTop: 20 }}>
        <button>{i18n.t('common.save')}</button>
        <button style={{ marginLeft: 8 }}>{i18n.t('common.cancel')}</button>
      </div>
      
      <div style={{ marginTop: 20 }}>
        <a href="#">{i18n.t('popup.settings')}</a>
        {' | '}
        <a href="#">{i18n.t('popup.help')}</a>
      </div>
    </div>
  );
}

export default App;
```

### 在其他脚本中使用

```typescript
// entrypoints/background.ts
import { i18n } from '#i18n';

export default defineBackground(() => {
  // 创建右键菜单
  browser.contextMenus.create({
    id: 'save-page',
    title: i18n.t('common.save'),
    contexts: ['page'],
  });

  // 显示通知
  browser.notifications.create({
    type: 'basic',
    iconUrl: browser.runtime.getURL('/icon/128.png'),
    title: i18n.t('extName'),
    message: i18n.t('messages.saveSuccess'),
  });
});
```

---

## 练习 11.3: Manifest 国际化

### 任务

国际化 manifest 中的字段。

### 步骤

manifest.json 使用特殊语法引用语言文件:

```typescript
// wxt.config.ts
export default defineConfig({
  manifest: {
    name: '__MSG_extName__',
    description: '__MSG_extDescription__',
    default_locale: 'zh_CN',
  },
});
```

WXT 会自动将语言文件转换为 Chrome 需要的格式:

```
public/
└── _locales/
    ├── zh_CN/
    │   └── messages.json
    ├── en/
    │   └── messages.json
    └── ja/
        └── messages.json
```

生成的 messages.json:

```json
{
  "extName": {
    "message": "我的扩展"
  },
  "extDescription": {
    "message": "一个强大的浏览器扩展"
  }
}
```

### 验证

```bash
# 构建后检查
pnpm build
cat .output/chrome-mv3/_locales/zh_CN/messages.json
cat .output/chrome-mv3/_locales/en/messages.json
```

---

## 练习 11.4: 带参数的翻译

### 任务

使用带参数的翻译文本。

### 步骤

1. 定义带参数的文本:

```yaml
# src/locales/zh_CN.yml
messages:
  greeting: 你好, $name$!
  itemCount: 共 $count$ 个项目
  dateRange: 从 $start$ 到 $end$
  
notifications:
  newItems: 您有 $count$ 条新消息
```

```yaml
# src/locales/en.yml
messages:
  greeting: Hello, $name$!
  itemCount: Total $count$ items
  dateRange: From $start$ to $end$
  
notifications:
  newItems: You have $count$ new messages
```

2. 使用参数:

```tsx
// entrypoints/popup/App.tsx
import { i18n } from '#i18n';

function App() {
  const username = 'Alice';
  const itemCount = 42;
  const startDate = '2024-01-01';
  const endDate = '2024-12-31';

  return (
    <div style={{ padding: 20 }}>
      {/* 单个参数 */}
      <p>{i18n.t('messages.greeting', { name: username })}</p>
      
      {/* 数字参数 */}
      <p>{i18n.t('messages.itemCount', { count: String(itemCount) })}</p>
      
      {/* 多个参数 */}
      <p>{i18n.t('messages.dateRange', { 
        start: startDate, 
        end: endDate 
      })}</p>
    </div>
  );
}
```

3. 在 Background 中使用:

```typescript
// entrypoints/background.ts
import { i18n } from '#i18n';

export default defineBackground(() => {
  // 监听新消息
  async function showNewMessageNotification(count: number) {
    await browser.notifications.create({
      type: 'basic',
      iconUrl: browser.runtime.getURL('/icon/128.png'),
      title: i18n.t('extName'),
      message: i18n.t('notifications.newItems', { count: String(count) }),
    });
  }

  // 示例调用
  showNewMessageNotification(5);
});
```

---

## 练习 11.5: 语言切换

### 任务

实现运行时语言切换。

### 步骤

1. 创建语言切换组件:

```tsx
// components/LanguageSelector.tsx
import { useState, useEffect } from 'react';
import { storage } from 'wxt/storage';

const languages = [
  { code: 'zh_CN', name: '简体中文' },
  { code: 'en', name: 'English' },
  { code: 'ja', name: '日本語' },
];

const languageStorage = storage.defineItem<string>('sync:language', {
  fallback: 'zh_CN',
});

export function LanguageSelector() {
  const [currentLang, setCurrentLang] = useState('zh_CN');

  useEffect(() => {
    languageStorage.getValue().then(setCurrentLang);
  }, []);

  const handleChange = async (lang: string) => {
    await languageStorage.setValue(lang);
    setCurrentLang(lang);
    
    // 通知其他页面刷新
    browser.runtime.sendMessage({ type: 'LANGUAGE_CHANGED', lang });
    
    // 刷新当前页面以应用新语言
    window.location.reload();
  };

  return (
    <select value={currentLang} onChange={e => handleChange(e.target.value)}>
      {languages.map(lang => (
        <option key={lang.code} value={lang.code}>
          {lang.name}
        </option>
      ))}
    </select>
  );
}
```

2. 创建自定义 i18n 工具:

```typescript
// utils/i18n.ts
import { storage } from 'wxt/storage';

// 语言包
const messages: Record<string, Record<string, string>> = {
  zh_CN: {
    'popup.title': '控制面板',
    'common.save': '保存',
    // ...
  },
  en: {
    'popup.title': 'Control Panel',
    'common.save': 'Save',
    // ...
  },
};

let currentLocale = 'zh_CN';

export async function initI18n() {
  const saved = await storage.getItem<string>('sync:language');
  if (saved && messages[saved]) {
    currentLocale = saved;
  }
}

export function t(key: string, params?: Record<string, string>): string {
  let text = messages[currentLocale]?.[key] || messages['en']?.[key] || key;
  
  if (params) {
    Object.entries(params).forEach(([k, v]) => {
      text = text.replace(new RegExp(`\\$${k}\\$`, 'g'), v);
    });
  }
  
  return text;
}

export function setLocale(locale: string) {
  if (messages[locale]) {
    currentLocale = locale;
    storage.setItem('sync:language', locale);
  }
}

export function getLocale() {
  return currentLocale;
}
```

3. 创建 React Hook:

```tsx
// hooks/useI18n.ts
import { useState, useEffect, useCallback } from 'react';
import { storage } from 'wxt/storage';
import { i18n } from '#i18n';

export function useI18n() {
  const [locale, setLocale] = useState('zh_CN');
  const [, forceUpdate] = useState({});

  useEffect(() => {
    storage.getItem<string>('sync:language').then(saved => {
      if (saved) setLocale(saved);
    });

    // 监听语言变化
    const handleMessage = (message: any) => {
      if (message.type === 'LANGUAGE_CHANGED') {
        setLocale(message.lang);
        forceUpdate({});
      }
    };

    browser.runtime.onMessage.addListener(handleMessage);
    return () => browser.runtime.onMessage.removeListener(handleMessage);
  }, []);

  const t = useCallback((key: string, params?: Record<string, string>) => {
    return i18n.t(key, params);
  }, [locale]);

  const changeLocale = useCallback(async (newLocale: string) => {
    await storage.setItem('sync:language', newLocale);
    setLocale(newLocale);
    browser.runtime.sendMessage({ type: 'LANGUAGE_CHANGED', lang: newLocale });
  }, []);

  return { t, locale, changeLocale };
}
```

---

## 练习 11.6: RTL 语言支持

### 任务

添加从右到左语言支持 (阿拉伯语、希伯来语等)。

### 步骤

1. 添加 RTL 语言文件:

```yaml
# src/locales/ar.yml
extName: امتدادي
extDescription: امتداد متصفح قوي

common:
  save: حفظ
  cancel: إلغاء
  
popup:
  title: لوحة التحكم
```

2. 检测并应用 RTL:

```typescript
// utils/rtl.ts
const rtlLanguages = ['ar', 'he', 'fa', 'ur'];

export function isRTL(locale: string): boolean {
  return rtlLanguages.some(lang => locale.startsWith(lang));
}

export function applyDirection(locale: string) {
  const dir = isRTL(locale) ? 'rtl' : 'ltr';
  document.documentElement.dir = dir;
  document.documentElement.lang = locale;
}
```

3. 在入口点应用:

```tsx
// entrypoints/popup/main.tsx
import { applyDirection } from '~/utils/rtl';
import { storage } from 'wxt/storage';

async function init() {
  const locale = await storage.getItem<string>('sync:language') || 'zh_CN';
  applyDirection(locale);
  
  ReactDOM.createRoot(document.getElementById('root')!).render(
    <App />
  );
}

init();
```

4. 添加 RTL 样式:

```css
/* styles/rtl.css */
[dir="rtl"] {
  text-align: right;
}

[dir="rtl"] .icon-left {
  transform: scaleX(-1);
}

[dir="rtl"] .margin-left {
  margin-left: 0;
  margin-right: 8px;
}
```

---

## 挑战练习

### 挑战: 完整的多语言设置页面

创建一个完整的设置页面,包含:
- 语言选择器
- 实时预览
- RTL 支持
- 语言自动检测

```tsx
// entrypoints/options/LanguageSettings.tsx
import { useState, useEffect } from 'react';
import { storage } from 'wxt/storage';
import { i18n } from '#i18n';
import { applyDirection, isRTL } from '~/utils/rtl';

const languages = [
  { code: 'zh_CN', name: '简体中文', nativeName: '简体中文' },
  { code: 'zh_TW', name: '繁體中文', nativeName: '繁體中文' },
  { code: 'en', name: 'English', nativeName: 'English' },
  { code: 'ja', name: '日本語', nativeName: '日本語' },
  { code: 'ko', name: '한국어', nativeName: '한국어' },
  { code: 'ar', name: 'Arabic', nativeName: 'العربية' },
];

export function LanguageSettings() {
  const [currentLang, setCurrentLang] = useState('zh_CN');
  const [autoDetect, setAutoDetect] = useState(false);

  useEffect(() => {
    loadSettings();
  }, []);

  async function loadSettings() {
    const lang = await storage.getItem<string>('sync:language');
    const auto = await storage.getItem<boolean>('sync:autoDetectLanguage');
    
    if (lang) setCurrentLang(lang);
    if (auto !== null) setAutoDetect(auto);
  }

  async function handleLanguageChange(lang: string) {
    setCurrentLang(lang);
    await storage.setItem('sync:language', lang);
    applyDirection(lang);
    
    // 通知所有页面
    browser.runtime.sendMessage({ type: 'LANGUAGE_CHANGED', lang });
  }

  async function handleAutoDetect(enabled: boolean) {
    setAutoDetect(enabled);
    await storage.setItem('sync:autoDetectLanguage', enabled);
    
    if (enabled) {
      // 使用浏览器语言
      const browserLang = navigator.language.replace('-', '_');
      const matched = languages.find(l => 
        browserLang.startsWith(l.code.split('_')[0])
      );
      if (matched) {
        handleLanguageChange(matched.code);
      }
    }
  }

  const isCurrentRTL = isRTL(currentLang);

  return (
    <div style={{ padding: 24 }}>
      <h2>{i18n.t('settings.language')}</h2>
      
      <div style={{ marginBottom: 20 }}>
        <label style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
          <input
            type="checkbox"
            checked={autoDetect}
            onChange={e => handleAutoDetect(e.target.checked)}
          />
          自动检测语言
        </label>
      </div>

      <div style={{ 
        display: 'grid', 
        gridTemplateColumns: 'repeat(3, 1fr)', 
        gap: 12 
      }}>
        {languages.map(lang => (
          <button
            key={lang.code}
            onClick={() => handleLanguageChange(lang.code)}
            disabled={autoDetect}
            style={{
              padding: '12px 16px',
              border: currentLang === lang.code ? '2px solid #1976d2' : '1px solid #ddd',
              borderRadius: 8,
              background: currentLang === lang.code ? '#e3f2fd' : 'white',
              cursor: autoDetect ? 'not-allowed' : 'pointer',
              textAlign: 'left',
              opacity: autoDetect ? 0.6 : 1,
            }}
          >
            <div style={{ fontWeight: 600 }}>{lang.nativeName}</div>
            <div style={{ fontSize: 12, color: '#666' }}>{lang.name}</div>
          </button>
        ))}
      </div>

      {/* 预览 */}
      <div style={{ 
        marginTop: 24, 
        padding: 16, 
        background: '#f5f5f5', 
        borderRadius: 8,
        direction: isCurrentRTL ? 'rtl' : 'ltr',
      }}>
        <h4>预览:</h4>
        <p>{i18n.t('popup.welcome')}</p>
        <button>{i18n.t('common.save')}</button>
        <button style={{ marginLeft: isCurrentRTL ? 0 : 8, marginRight: isCurrentRTL ? 8 : 0 }}>
          {i18n.t('common.cancel')}
        </button>
      </div>
    </div>
  );
}
```

---

## 自我检查

1. WXT 使用什么模块支持 i18n?
2. 语言文件应该放在哪个目录?
3. manifest 中如何引用语言文本?
4. 如何传递参数给翻译函数?
5. 如何支持 RTL 语言?

## 参考答案

1. @wxt-dev/i18n 模块
2. src/locales/ 目录,文件名为语言代码 (如 zh_CN.yml, en.yml)
3. 使用 `__MSG_keyName__` 格式
4. 使用 `$paramName$` 占位符,调用时传入对象: `i18n.t('key', { paramName: 'value' })`
5. 检测语言是否为 RTL,然后设置 document.documentElement.dir = 'rtl'
